import{u as ze,L as Re}from"./Loading-46Jn4shg.js";import{g as Pe}from"./_commonjsHelpers-Cpj98o6Y.js";import{c as Be}from"./_commonjs-dynamic-modules-TDtrdbi3.js";import{_ as Ve,b as Fe,o as Te,c as Ne,w as Ie,a as be,u as Ee}from"./index-38Gdk1hV.js";import"./allscreen-BAmTLS2a.js";import"./loading-DCIqHNX2.js";var Ce={exports:{}};(function(Ae,Zt){(function(v){Ae.exports=v()})(function(){return function v(N,ct,p){function e(l,o){if(!ct[l]){if(!N[l]){var t=typeof Be=="function"&&Be;if(!o&&t)return t(l,!0);if(s)return s(l,!0);throw new Error("Cannot find module '"+l+"'")}var i=ct[l]={exports:{}};N[l][0].call(i.exports,function(n){var a=N[l][1][n];return e(a||n)},i,i.exports,v,N,ct,p)}return ct[l].exports}for(var s=typeof Be=="function"&&Be,r=0;r<p.length;r++)e(p[r]);return e}({1:[function(v,N,ct){N.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(v,N,ct){N.exports={version:v("../package.json").version,AABB:v("./collision/AABB"),ArrayCollisionMatrix:v("./collision/ArrayCollisionMatrix"),Body:v("./objects/Body"),Box:v("./shapes/Box"),Broadphase:v("./collision/Broadphase"),Constraint:v("./constraints/Constraint"),ContactEquation:v("./equations/ContactEquation"),Narrowphase:v("./world/Narrowphase"),ConeTwistConstraint:v("./constraints/ConeTwistConstraint"),ContactMaterial:v("./material/ContactMaterial"),ConvexPolyhedron:v("./shapes/ConvexPolyhedron"),Cylinder:v("./shapes/Cylinder"),DistanceConstraint:v("./constraints/DistanceConstraint"),Equation:v("./equations/Equation"),EventTarget:v("./utils/EventTarget"),FrictionEquation:v("./equations/FrictionEquation"),GSSolver:v("./solver/GSSolver"),GridBroadphase:v("./collision/GridBroadphase"),Heightfield:v("./shapes/Heightfield"),HingeConstraint:v("./constraints/HingeConstraint"),LockConstraint:v("./constraints/LockConstraint"),Mat3:v("./math/Mat3"),Material:v("./material/Material"),NaiveBroadphase:v("./collision/NaiveBroadphase"),ObjectCollisionMatrix:v("./collision/ObjectCollisionMatrix"),Pool:v("./utils/Pool"),Particle:v("./shapes/Particle"),Plane:v("./shapes/Plane"),PointToPointConstraint:v("./constraints/PointToPointConstraint"),Quaternion:v("./math/Quaternion"),Ray:v("./collision/Ray"),RaycastVehicle:v("./objects/RaycastVehicle"),RaycastResult:v("./collision/RaycastResult"),RigidVehicle:v("./objects/RigidVehicle"),RotationalEquation:v("./equations/RotationalEquation"),RotationalMotorEquation:v("./equations/RotationalMotorEquation"),SAPBroadphase:v("./collision/SAPBroadphase"),SPHSystem:v("./objects/SPHSystem"),Shape:v("./shapes/Shape"),Solver:v("./solver/Solver"),Sphere:v("./shapes/Sphere"),SplitSolver:v("./solver/SplitSolver"),Spring:v("./objects/Spring"),Trimesh:v("./shapes/Trimesh"),Vec3:v("./math/Vec3"),Vec3Pool:v("./utils/Vec3Pool"),World:v("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(v,N,ct){var p=v("../math/Vec3");v("../utils/Utils"),N.exports=e;function e(l){l=l||{},this.lowerBound=new p,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new p,l.upperBound&&this.upperBound.copy(l.upperBound)}var s=new p;e.prototype.setFromPoints=function(l,o,t,i){var n=this.lowerBound,a=this.upperBound,c=t;n.copy(l[0]),c&&c.vmult(n,n),a.copy(n);for(var h=1;h<l.length;h++){var u=l[h];c&&(c.vmult(u,s),u=s),u.x>a.x&&(a.x=u.x),u.x<n.x&&(n.x=u.x),u.y>a.y&&(a.y=u.y),u.y<n.y&&(n.y=u.y),u.z>a.z&&(a.z=u.z),u.z<n.z&&(n.z=u.z)}return o&&(o.vadd(n,n),o.vadd(a,a)),i&&(n.x-=i,n.y-=i,n.z-=i,a.x+=i,a.y+=i,a.z+=i),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var o=l.lowerBound.x;this.lowerBound.x>o&&(this.lowerBound.x=o);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var o=l.lowerBound.y;this.lowerBound.y>o&&(this.lowerBound.y=o);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var o=l.lowerBound.z;this.lowerBound.z>o&&(this.lowerBound.z=o);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,n=l.upperBound;return(i.x<=t.x&&t.x<=n.x||o.x<=n.x&&n.x<=t.x)&&(i.y<=t.y&&t.y<=n.y||o.y<=n.y&&n.y<=t.y)&&(i.z<=t.z&&t.z<=n.z||o.z<=n.z&&n.z<=t.z)},e.prototype.contains=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,n=l.upperBound;return o.x<=i.x&&t.x>=n.x&&o.y<=i.y&&t.y>=n.y&&o.z<=i.z&&t.z>=n.z},e.prototype.getCorners=function(l,o,t,i,n,a,c,h){var u=this.lowerBound,d=this.upperBound;l.copy(u),o.set(d.x,u.y,u.z),t.set(d.x,d.y,u.z),i.set(u.x,d.y,d.z),n.set(d.x,u.y,u.z),a.set(u.x,d.y,u.z),c.set(u.x,u.y,d.z),h.copy(d)};var r=[new p,new p,new p,new p,new p,new p,new p,new p];e.prototype.toLocalFrame=function(l,o){var t=r,i=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(i,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToLocal(b,b)}return o.setFromPoints(t)},e.prototype.toWorldFrame=function(l,o){var t=r,i=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(i,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToWorld(b,b)}return o.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(v,N,ct){N.exports=p;function p(){this.matrix=[]}p.prototype.get=function(e,s){if(e=e.index,s=s.index,s>e){var r=s;s=e,e=r}return this.matrix[(e*(e+1)>>1)+s-1]},p.prototype.set=function(e,s,r){if(e=e.index,s=s.index,s>e){var l=s;s=e,e=l}this.matrix[(e*(e+1)>>1)+s-1]=r?1:0},p.prototype.reset=function(){for(var e=0,s=this.matrix.length;e!==s;e++)this.matrix[e]=0},p.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(v,N,ct){var p=v("../objects/Body"),e=v("../math/Vec3"),s=v("../math/Quaternion");v("../shapes/Shape"),v("../shapes/Plane"),N.exports=r;function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}r.prototype.collisionPairs=function(c,h,u){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=p.STATIC|p.KINEMATIC;r.prototype.needBroadphaseCollision=function(c,h){return!(!(c.collisionFilterGroup&h.collisionFilterMask)||!(h.collisionFilterGroup&c.collisionFilterMask)||(c.type&l||c.sleepState===p.SLEEPING)&&(h.type&l||h.sleepState===p.SLEEPING))},r.prototype.intersectionTest=function(c,h,u,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(c,h,u,d):this.doBoundingSphereBroadphase(c,h,u,d)};var o=new e;new e,new s,new e,r.prototype.doBoundingSphereBroadphase=function(c,h,u,d){var x=o;h.position.vsub(c.position,x);var f=Math.pow(c.boundingRadius+h.boundingRadius,2),b=x.norm2();b<f&&(u.push(c),d.push(h))},r.prototype.doBoundingBoxBroadphase=function(c,h,u,d){c.aabbNeedsUpdate&&c.computeAABB(),h.aabbNeedsUpdate&&h.computeAABB(),c.aabb.overlaps(h.aabb)&&(u.push(c),d.push(h))};var t={keys:[]},i=[],n=[];r.prototype.makePairsUnique=function(c,h){for(var u=t,d=i,x=n,f=c.length,b=0;b!==f;b++)d[b]=c[b],x[b]=h[b];c.length=0,h.length=0;for(var b=0;b!==f;b++){var U=d[b].id,rt=x[b].id,P=U<rt?U+","+rt:rt+","+U;u[P]=b,u.keys.push(P)}for(var b=0;b!==u.keys.length;b++){var P=u.keys.pop(),k=u[P];c.push(d[k]),h.push(x[k]),delete u[P]}},r.prototype.setWorld=function(c){};var a=new e;r.boundingSphereCheck=function(c,h){var u=a;return c.position.vsub(h.position,u),Math.pow(c.shape.boundingSphereRadius+h.shape.boundingSphereRadius,2)>u.norm2()},r.prototype.aabbQuery=function(c,h,u){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(v,N,ct){N.exports=r;var p=v("./Broadphase"),e=v("../math/Vec3"),s=v("../shapes/Shape");function r(o,t,i,n,a){p.apply(this),this.nx=i||10,this.ny=n||10,this.nz=a||10,this.aabbMin=o||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var h=0;h<c;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new p,r.prototype.constructor=r;var l=new e;new e,r.prototype.collisionPairs=function(o,t,i){var n=o.numObjects(),a=o.bodies,G=this.aabbMax,C=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,d=h*u,x=u,f=1,b=G.x,U=G.y,rt=G.z,P=C.x,k=C.y,M=C.z,B=c/(b-P),T=h/(U-k),F=u/(rt-M),K=(b-P)/c,Z=(U-k)/h,ut=(rt-M)/u,R=Math.sqrt(K*K+Z*Z+ut*ut)*.5,A=s.types,X=A.SPHERE,q=A.PLANE;A.BOX,A.COMPOUND,A.CONVEXPOLYHEDRON;for(var g=this.bins,z=this.binLengths,w=this.bins.length,m=0;m!==w;m++)z[m]=0;var y=Math.ceil,C=Math.min,G=Math.max;function W(ne,ue,ae,Kt,jt,ve,pe){var ie=(ne-P)*B|0,ee=(ue-k)*T|0,Yt=(ae-M)*F|0,re=y((Kt-P)*B),oe=y((jt-k)*T),Gt=y((ve-M)*F);ie<0?ie=0:ie>=c&&(ie=c-1),ee<0?ee=0:ee>=h&&(ee=h-1),Yt<0?Yt=0:Yt>=u&&(Yt=u-1),re<0?re=0:re>=c&&(re=c-1),oe<0?oe=0:oe>=h&&(oe=h-1),Gt<0?Gt=0:Gt>=u&&(Gt=u-1),ie*=d,ee*=x,Yt*=f,re*=d,oe*=x,Gt*=f;for(var de=ie;de<=re;de+=d)for(var fe=ee;fe<=oe;fe+=x)for(var ye=Yt;ye<=Gt;ye+=f){var xe=de+fe+ye;g[xe][z[xe]++]=pe}}for(var m=0;m!==n;m++){var E=a[m],L=E.shape;switch(L.type){case X:var _=E.position.x,pt=E.position.y,st=E.position.z,at=L.radius;W(_-at,pt-at,st-at,_+at,pt+at,st+at,E);break;case q:L.worldNormalNeedsUpdate&&L.computeWorldNormal(E.quaternion);var O=L.worldNormal,Q=P+K*.5-E.position.x,bt=k+Z*.5-E.position.y,ft=M+ut*.5-E.position.z,Rt=l;Rt.set(Q,bt,ft);for(var ht=0,St=0;ht!==c;ht++,St+=d,Rt.y=bt,Rt.x+=K)for(var zt=0,Mt=0;zt!==h;zt++,Mt+=x,Rt.z=ft,Rt.y+=Z)for(var Vt=0,At=0;Vt!==u;Vt++,At+=f,Rt.z+=ut)if(Rt.dot(O)<R){var Ft=St+Mt+At;g[Ft][z[Ft]++]=E}break;default:E.aabbNeedsUpdate&&E.computeAABB(),W(E.aabb.lowerBound.x,E.aabb.lowerBound.y,E.aabb.lowerBound.z,E.aabb.upperBound.x,E.aabb.upperBound.y,E.aabb.upperBound.z,E);break}}for(var m=0;m!==w;m++){var Et=z[m];if(Et>1)for(var Wt=g[m],ht=0;ht!==Et;ht++)for(var E=Wt[ht],zt=0;zt!==ht;zt++){var Ut=Wt[zt];this.needBroadphaseCollision(E,Ut)&&this.intersectionTest(E,Ut,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(v,N,ct){N.exports=s;var p=v("./Broadphase"),e=v("./AABB");function s(){p.apply(this)}s.prototype=new p,s.prototype.constructor=s,s.prototype.collisionPairs=function(r,l,o){var t=r.bodies,i=t.length,n,a,c,h;for(n=0;n!==i;n++)for(a=0;a!==n;a++)c=t[n],h=t[a],this.needBroadphaseCollision(c,h)&&this.intersectionTest(c,h,l,o)},new e,s.prototype.aabbQuery=function(r,l,o){o=o||[];for(var t=0;t<r.bodies.length;t++){var i=r.bodies[t];i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(l)&&o.push(i)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(v,N,ct){N.exports=p;function p(){this.matrix={}}p.prototype.get=function(e,s){if(e=e.id,s=s.id,s>e){var r=s;s=e,e=r}return e+"-"+s in this.matrix},p.prototype.set=function(e,s,r){if(e=e.id,s=s.id,s>e){var l=s;s=e,e=l}r?this.matrix[e+"-"+s]=!0:delete this.matrix[e+"-"+s]},p.prototype.reset=function(){this.matrix={}},p.prototype.setNumObjects=function(e){}},{}],9:[function(v,N,ct){N.exports=t;var p=v("../math/Vec3"),e=v("../math/Quaternion"),s=v("../math/Transform");v("../shapes/ConvexPolyhedron"),v("../shapes/Box");var r=v("../collision/RaycastResult"),l=v("../shapes/Shape"),o=v("../collision/AABB");function t(w,m){this.from=w?w.clone():new p,this.to=m?m.clone():new p,this._direction=new p,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new r,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var i=new o,n=[];t.prototype.intersectWorld=function(w,m){return this.mode=m.mode||t.ANY,this.result=m.result||new r,this.skipBackfaces=!!m.skipBackfaces,this.collisionFilterMask=typeof m.collisionFilterMask<"u"?m.collisionFilterMask:-1,this.collisionFilterGroup=typeof m.collisionFilterGroup<"u"?m.collisionFilterGroup:-1,m.from&&this.from.copy(m.from),m.to&&this.to.copy(m.to),this.callback=m.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(i),n.length=0,w.broadphase.aabbQuery(w,i,n),this.intersectBodies(n),this.hasHit};var a=new p,c=new p;t.pointInTriangle=h;function h(w,m,y,C){C.vsub(m,q),y.vsub(m,a),w.vsub(m,c);var G=q.dot(q),W=q.dot(a),E=q.dot(c),L=a.dot(a),_=a.dot(c),pt,st;return(pt=L*E-W*_)>=0&&(st=G*_-W*E)>=0&&pt+st<G*L-W*W}var u=new p,d=new e;t.prototype.intersectBody=function(w,m){m&&(this.result=m,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!w.collisionResponse)&&!(!(this.collisionFilterGroup&w.collisionFilterMask)||!(w.collisionFilterGroup&this.collisionFilterMask)))for(var C=u,G=d,W=0,E=w.shapes.length;W<E;W++){var L=w.shapes[W];if(!(y&&!L.collisionResponse)&&(w.quaternion.mult(w.shapeOrientations[W],G),w.quaternion.vmult(w.shapeOffsets[W],C),C.vadd(w.position,C),this.intersectShape(L,G,C,w),this.result._shouldStop))break}},t.prototype.intersectBodies=function(w,m){m&&(this.result=m,this._updateDirection());for(var y=0,C=w.length;!this.result._shouldStop&&y<C;y++)this.intersectBody(w[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(w,m,y,C){var G=this.from,W=z(G,this._direction,y);if(!(W>w.boundingSphereRadius)){var E=this[w.type];E&&E.call(this,w,m,y,C)}},new p,new p;var x=new p,f=new p,b=new p,U=new p;new p,new r,t.prototype.intersectBox=function(w,m,y,C){return this.intersectConvex(w.convexPolyhedronRepresentation,m,y,C)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(w,m,y,C){var G=this.from,W=this.to,E=this._direction,L=new p(0,0,1);m.vmult(L,L);var _=new p;G.vsub(y,_);var pt=_.dot(L);W.vsub(y,_);var st=_.dot(L);if(!(pt*st>0)&&!(G.distanceTo(W)<pt)){var at=L.dot(E);if(!(Math.abs(at)<this.precision)){var O=new p,Q=new p,bt=new p;G.vsub(y,O);var ft=-L.dot(O)/at;E.scale(ft,Q),G.vadd(Q,bt),this.reportIntersection(L,bt,w,C,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(w){var m=this.to,y=this.from;w.lowerBound.x=Math.min(m.x,y.x),w.lowerBound.y=Math.min(m.y,y.y),w.lowerBound.z=Math.min(m.z,y.z),w.upperBound.x=Math.max(m.x,y.x),w.upperBound.y=Math.max(m.y,y.y),w.upperBound.z=Math.max(m.z,y.z)};var rt={faceList:[0]};t.prototype.intersectHeightfield=function(w,m,y,C){w.data,w.elementSize;var G=new p,W=new t(this.from,this.to);s.pointToLocalFrame(y,m,W.from,W.from),s.pointToLocalFrame(y,m,W.to,W.to);var E=[],L=null,_=null,pt=null,st=null,at=w.getIndexOfPosition(W.from.x,W.from.y,E,!1);if(at&&(L=E[0],_=E[1],pt=E[0],st=E[1]),at=w.getIndexOfPosition(W.to.x,W.to.y,E,!1),at&&((L===null||E[0]<L)&&(L=E[0]),(pt===null||E[0]>pt)&&(pt=E[0]),(_===null||E[1]<_)&&(_=E[1]),(st===null||E[1]>st)&&(st=E[1])),L!==null){var O=[];w.getRectMinMax(L,_,pt,st,O),O[0],O[1];for(var Q=L;Q<=pt;Q++)for(var bt=_;bt<=st;bt++){if(this.result._shouldStop||(w.getConvexTrianglePillar(Q,bt,!1),s.pointToWorldFrame(y,m,w.pillarOffset,G),this.intersectConvex(w.pillarConvex,m,G,C,rt),this.result._shouldStop))return;w.getConvexTrianglePillar(Q,bt,!0),s.pointToWorldFrame(y,m,w.pillarOffset,G),this.intersectConvex(w.pillarConvex,m,G,C,rt)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var P=new p,k=new p;t.prototype.intersectSphere=function(w,m,y,C){var G=this.from,W=this.to,E=w.radius,L=Math.pow(W.x-G.x,2)+Math.pow(W.y-G.y,2)+Math.pow(W.z-G.z,2),_=2*((W.x-G.x)*(G.x-y.x)+(W.y-G.y)*(G.y-y.y)+(W.z-G.z)*(G.z-y.z)),pt=Math.pow(G.x-y.x,2)+Math.pow(G.y-y.y,2)+Math.pow(G.z-y.z,2)-Math.pow(E,2),st=Math.pow(_,2)-4*L*pt,at=P,O=k;if(!(st<0))if(st===0)G.lerp(W,st,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1);else{var Q=(-_-Math.sqrt(st))/(2*L),bt=(-_+Math.sqrt(st))/(2*L);if(Q>=0&&Q<=1&&(G.lerp(W,Q,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1)),this.result._shouldStop)return;bt>=0&&bt<=1&&(G.lerp(W,bt,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var M=new p;new p,new p;var B=new p;t.prototype.intersectConvex=function(m,y,C,G,W){for(var E=M,L=B,_=W&&W.faceList||null,pt=m.faces,st=m.vertices,at=m.faceNormals,O=this._direction,Q=this.from,bt=this.to,ft=Q.distanceTo(bt),Rt=_?_.length:pt.length,ht=this.result,St=0;!ht._shouldStop&&St<Rt;St++){var zt=_?_[St]:St,Mt=pt[zt],Vt=at[zt],At=y,Ft=C;L.copy(st[Mt[0]]),At.vmult(L,L),L.vadd(Ft,L),L.vsub(Q,L),At.vmult(Vt,E);var Et=O.dot(E);if(!(Math.abs(Et)<this.precision)){var Wt=E.dot(L)/Et;if(!(Wt<0)){O.mult(Wt,x),x.vadd(Q,x),f.copy(st[Mt[0]]),At.vmult(f,f),Ft.vadd(f,f);for(var Ut=1;!ht._shouldStop&&Ut<Mt.length-1;Ut++){b.copy(st[Mt[Ut]]),U.copy(st[Mt[Ut+1]]),At.vmult(b,b),At.vmult(U,U),Ft.vadd(b,b),Ft.vadd(U,U);var ne=x.distanceTo(Q);!(h(x,f,b,U)||h(x,b,f,U))||ne>ft||this.reportIntersection(E,x,m,G,zt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var T=new p,F=new p,K=new p,Z=new p,ut=new p,R=new p;new o;var A=[],X=new s;t.prototype.intersectTrimesh=function(m,y,C,G,W){var E=T,L=A,_=X,pt=B,st=F,at=K,O=Z,Q=R,bt=ut;W&&W.faceList;var ft=m.indices;m.vertices,m.faceNormals;var Rt=this.from,ht=this.to,St=this._direction;_.position.copy(C),_.quaternion.copy(y),s.vectorToLocalFrame(C,y,St,st),s.pointToLocalFrame(C,y,Rt,at),s.pointToLocalFrame(C,y,ht,O);var zt=at.distanceSquared(O);m.tree.rayQuery(this,_,L);for(var Mt=0,Vt=L.length;!this.result._shouldStop&&Mt!==Vt;Mt++){var At=L[Mt];m.getNormal(At,E),m.getVertex(ft[At*3],f),f.vsub(at,pt);var Ft=st.dot(E),Et=E.dot(pt)/Ft;if(!(Et<0)){st.scale(Et,x),x.vadd(at,x),m.getVertex(ft[At*3+1],b),m.getVertex(ft[At*3+2],U);var Wt=x.distanceSquared(at);!(h(x,b,f,U)||h(x,f,b,U))||Wt>zt||(s.vectorToWorldFrame(y,E,bt),s.pointToWorldFrame(C,y,x,Q),this.reportIntersection(bt,Q,m,G,At))}}L.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(w,m,y,C,G){var W=this.from,E=this.to,L=W.distanceTo(m),_=this.result;if(!(this.skipBackfaces&&w.dot(this._direction)>0))switch(_.hitFaceIndex=typeof G<"u"?G:-1,this.mode){case t.ALL:this.hasHit=!0,_.set(W,E,w,m,y,C,L),_.hasHit=!0,this.callback(_);break;case t.CLOSEST:(L<_.distance||!_.hasHit)&&(this.hasHit=!0,_.hasHit=!0,_.set(W,E,w,m,y,C,L));break;case t.ANY:this.hasHit=!0,_.hasHit=!0,_.set(W,E,w,m,y,C,L),_._shouldStop=!0;break}};var q=new p,g=new p;function z(w,m,y){y.vsub(w,q);var C=q.dot(m);m.mult(C,g),g.vadd(w,g);var G=y.distanceTo(g);return G}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(v,N,ct){var p=v("../math/Vec3");N.exports=e;function e(){this.rayFromWorld=new p,this.rayToWorld=new p,this.hitNormalWorld=new p,this.hitPointWorld=new p,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(s,r,l,o,t,i,n){this.rayFromWorld.copy(s),this.rayToWorld.copy(r),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(o),this.shape=t,this.body=i,this.distance=n}},{"../math/Vec3":30}],11:[function(v,N,ct){v("../shapes/Shape");var p=v("../collision/Broadphase");N.exports=e;function e(s){p.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var r=this.axisList;this._addBodyHandler=function(l){r.push(l.body)},this._removeBodyHandler=function(l){var o=r.indexOf(l.body);o!==-1&&r.splice(o,1)},s&&this.setWorld(s)}e.prototype=new p,e.prototype.setWorld=function(s){this.axisList.length=0;for(var r=0;r<s.bodies.length;r++)this.axisList.push(s.bodies[r]);s.removeEventListener("addBody",this._addBodyHandler),s.removeEventListener("removeBody",this._removeBodyHandler),s.addEventListener("addBody",this._addBodyHandler),s.addEventListener("removeBody",this._removeBodyHandler),this.world=s,this.dirty=!0},e.insertionSortX=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.x<=o.aabb.lowerBound.x);t--)s[t+1]=s[t];s[t+1]=o}return s},e.insertionSortY=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.y<=o.aabb.lowerBound.y);t--)s[t+1]=s[t];s[t+1]=o}return s},e.insertionSortZ=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.z<=o.aabb.lowerBound.z);t--)s[t+1]=s[t];s[t+1]=o}return s},e.prototype.collisionPairs=function(s,r,l){var o=this.axisList,t=o.length,i=this.axisIndex,n,a;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==t;n++){var c=o[n];for(a=n+1;a<t;a++){var h=o[a];if(this.needBroadphaseCollision(c,h)){if(!e.checkBounds(c,h,i))break;this.intersectionTest(c,h,r,l)}}}},e.prototype.sortList=function(){for(var s=this.axisList,r=this.axisIndex,l=s.length,o=0;o!==l;o++){var t=s[o];t.aabbNeedsUpdate&&t.computeAABB()}r===0?e.insertionSortX(s):r===1?e.insertionSortY(s):r===2&&e.insertionSortZ(s)},e.checkBounds=function(s,r,l){var o,t;l===0?(o=s.position.x,t=r.position.x):l===1?(o=s.position.y,t=r.position.y):l===2&&(o=s.position.z,t=r.position.z);var i=s.boundingRadius,n=r.boundingRadius,a=o+i,c=t-n;return c<a},e.prototype.autoDetectAxis=function(){for(var s=0,r=0,l=0,o=0,t=0,i=0,n=this.axisList,a=n.length,c=1/a,h=0;h!==a;h++){var u=n[h],d=u.position.x;s+=d,r+=d*d;var x=u.position.y;l+=x,o+=x*x;var f=u.position.z;t+=f,i+=f*f}var b=r-s*s*c,U=o-l*l*c,rt=i-t*t*c;b>U?b>rt?this.axisIndex=0:this.axisIndex=2:U>rt?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(s,r,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,t="x";o===1&&(t="y"),o===2&&(t="z");var i=this.axisList;r.lowerBound[t],r.upperBound[t];for(var n=0;n<i.length;n++){var a=i[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(r)&&l.push(a)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(v,N,ct){N.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/ConeEquation"),s=v("../equations/RotationalEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6,a=i.pivotA?i.pivotA.clone():new r,c=i.pivotB?i.pivotB.clone():new r;this.axisA=i.axisA?i.axisA.clone():new r,this.axisB=i.axisB?i.axisB.clone():new r,p.call(this,o,a,t,c,n),this.collideConnected=!!i.collideConnected,this.angle=typeof i.angle<"u"?i.angle:0;var h=this.coneEquation=new e(o,t,i),u=this.twistEquation=new s(o,t,i);this.twistAngle=typeof i.twistAngle<"u"?i.twistAngle:0,h.maxForce=0,h.minForce=-n,u.maxForce=0,u.minForce=-n,this.equations.push(h,u)}l.prototype=new p,l.constructor=l,new r,new r,l.prototype.update=function(){var o=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;p.prototype.update.call(this),o.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),o.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(v,N,ct){N.exports=e;var p=v("../utils/Utils");function e(s,r,l){l=p.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=s,this.bodyB=r,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(s&&s.wakeUp(),r&&r.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!0},e.prototype.disable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(v,N,ct){N.exports=s;var p=v("./Constraint"),e=v("../equations/ContactEquation");function s(r,l,o,t){p.call(this,r,l),typeof o>"u"&&(o=r.position.distanceTo(l.position)),typeof t>"u"&&(t=1e6),this.distance=o;var i=this.distanceEquation=new e(r,l);this.equations.push(i),i.minForce=-t,i.maxForce=t}s.prototype=new p,s.prototype.update=function(){var r=this.bodyA,l=this.bodyB,o=this.distanceEquation,t=this.distance*.5,i=o.ni;l.position.vsub(r.position,i),i.normalize(),i.mult(t,o.ri),i.mult(-t,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(v,N,ct){N.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation"),s=v("../equations/RotationalMotorEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(i,n,a){a=a||{};var c=typeof a.maxForce<"u"?a.maxForce:1e6,h=a.pivotA?a.pivotA.clone():new r,u=a.pivotB?a.pivotB.clone():new r;p.call(this,i,h,n,u,c);var d=this.axisA=a.axisA?a.axisA.clone():new r(1,0,0);d.normalize();var x=this.axisB=a.axisB?a.axisB.clone():new r(1,0,0);x.normalize();var f=this.rotationalEquation1=new e(i,n,a),b=this.rotationalEquation2=new e(i,n,a),U=this.motorEquation=new s(i,n,c);U.enabled=!1,this.equations.push(f,b,U)}l.prototype=new p,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(i){this.motorEquation.targetVelocity=i},l.prototype.setMotorMaxForce=function(i){this.motorEquation.maxForce=i,this.motorEquation.minForce=-i};var o=new r,t=new r;l.prototype.update=function(){var i=this.bodyA,n=this.bodyB,a=this.motorEquation,c=this.rotationalEquation1,h=this.rotationalEquation2,u=o,d=t,x=this.axisA,f=this.axisB;p.prototype.update.call(this),i.quaternion.vmult(x,u),n.quaternion.vmult(f,d),u.tangents(c.axisA,h.axisA),c.axisB.copy(d),h.axisB.copy(d),this.motorEquation.enabled&&(i.quaternion.vmult(this.axisA,a.axisA),n.quaternion.vmult(this.axisB,a.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(v,N,ct){N.exports=r,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation");v("../equations/RotationalMotorEquation"),v("../equations/ContactEquation");var s=v("../math/Vec3");function r(l,o,t){t=t||{};var i=typeof t.maxForce<"u"?t.maxForce:1e6,n=new s,a=new s,c=new s;l.position.vadd(o.position,c),c.scale(.5,c),o.pointToLocalFrame(c,a),l.pointToLocalFrame(c,n),p.call(this,l,n,o,a,i);var h=this.rotationalEquation1=new e(l,o,t),u=this.rotationalEquation2=new e(l,o,t),d=this.rotationalEquation3=new e(l,o,t);this.equations.push(h,u,d)}r.prototype=new p,r.constructor=r,new s,new s,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,i=this.rotationalEquation2,n=this.rotationalEquation3;p.prototype.update.call(this),l.vectorToWorldFrame(s.UNIT_X,t.axisA),o.vectorToWorldFrame(s.UNIT_Y,t.axisB),l.vectorToWorldFrame(s.UNIT_Y,i.axisA),o.vectorToWorldFrame(s.UNIT_Z,i.axisB),l.vectorToWorldFrame(s.UNIT_Z,n.axisA),o.vectorToWorldFrame(s.UNIT_X,n.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(v,N,ct){N.exports=r;var p=v("./Constraint"),e=v("../equations/ContactEquation"),s=v("../math/Vec3");function r(l,o,t,i,n){p.call(this,l,t),n=typeof n<"u"?n:1e6,this.pivotA=o?o.clone():new s,this.pivotB=i?i.clone():new s;var a=this.equationX=new e(l,t),c=this.equationY=new e(l,t),h=this.equationZ=new e(l,t);this.equations.push(a,c,h),a.minForce=c.minForce=h.minForce=-n,a.maxForce=c.maxForce=h.maxForce=n,a.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new p,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB,t=this.equationX,i=this.equationY,n=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),o.quaternion.vmult(this.pivotB,t.rj),i.ri.copy(t.ri),i.rj.copy(t.rj),n.ri.copy(t.ri),n.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(v,N,ct){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.angle=typeof i.angle<"u"?i.angle:0}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(o){var t=this.a,i=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.angle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),U=-x*t-f*i-o*b;return U}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(v,N,ct){N.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(h,u,d){d=typeof d<"u"?d:1e6,p.call(this,h,u,0,d),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e,o=new e;s.prototype.computeB=function(h){var u=this.a,d=this.b,x=this.bi,f=this.bj,b=this.ri,U=this.rj,rt=r,P=l,k=x.velocity,M=x.angularVelocity;x.force,x.torque;var B=f.velocity,T=f.angularVelocity;f.force,f.torque;var F=o,K=this.jacobianElementA,Z=this.jacobianElementB,ut=this.ni;b.cross(ut,rt),U.cross(ut,P),ut.negate(K.spatial),rt.negate(K.rotational),Z.spatial.copy(ut),Z.rotational.copy(P),F.copy(f.position),F.vadd(U,F),F.vsub(x.position,F),F.vsub(b,F);var R=ut.dot(F),A=this.restitution+1,X=A*B.dot(ut)-A*k.dot(ut)+T.dot(P)-M.dot(rt),q=this.computeGiMf(),g=-R*u-X*d-h*q;return g};var t=new e,i=new e,n=new e,a=new e,c=new e;s.prototype.getImpactVelocityAlongNormal=function(){var h=t,u=i,d=n,x=a,f=c;return this.bi.position.vadd(this.ri,d),this.bj.position.vadd(this.rj,x),this.bi.getVelocityAtWorldPoint(d,h),this.bj.getVelocityAtWorldPoint(x,u),h.vsub(u,f),this.ni.dot(f)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(v,N,ct){N.exports=s;var p=v("../math/JacobianElement"),e=v("../math/Vec3");function s(c,h,u,d){this.id=s.id++,this.minForce=typeof u>"u"?-1e6:u,this.maxForce=typeof d>"u"?1e6:d,this.bi=c,this.bj=h,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new p,this.jacobianElementB=new p,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s,s.id=0,s.prototype.setSpookParams=function(c,h,u){var d=h,x=c,f=u;this.a=4/(f*(1+4*d)),this.b=4*d/(1+4*d),this.eps=4/(f*f*x*(1+4*d))},s.prototype.computeB=function(c,h,u){var d=this.computeGW(),x=this.computeGq(),f=this.computeGiMf();return-x*c-d*h-f*u},s.prototype.computeGq=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.position,f=d.position;return c.spatial.dot(x)+h.spatial.dot(f)};var r=new e;s.prototype.computeGW=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.velocity,f=d.velocity,b=u.angularVelocity||r,U=d.angularVelocity||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,U)},s.prototype.computeGWlambda=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.vlambda,f=d.vlambda,b=u.wlambda||r,U=d.wlambda||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,U)};var l=new e,o=new e,t=new e,i=new e;s.prototype.computeGiMf=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.force,f=u.torque,b=d.force,U=d.torque,rt=u.invMassSolve,P=d.invMassSolve;return u.invInertiaWorldSolve?u.invInertiaWorldSolve.vmult(f,t):t.set(0,0,0),d.invInertiaWorldSolve?d.invInertiaWorldSolve.vmult(U,i):i.set(0,0,0),x.mult(rt,l),b.mult(P,o),c.multiplyVectors(l,t)+h.multiplyVectors(o,i)};var n=new e;s.prototype.computeGiMGt=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.invMassSolve,f=d.invMassSolve,b=u.invInertiaWorldSolve,U=d.invInertiaWorldSolve,rt=x+f;return b&&(b.vmult(c.rotational,n),rt+=n.dot(c.rotational)),U&&(U.vmult(h.rotational,n),rt+=n.dot(h.rotational)),rt};var a=new e;new e,new e,new e,new e,new e,s.prototype.addToWlambda=function(c){var h=this.jacobianElementA,u=this.jacobianElementB,d=this.bi,x=this.bj,f=a;h.spatial.mult(d.invMassSolve*c,f),d.vlambda.vadd(f,d.vlambda),u.spatial.mult(x.invMassSolve*c,f),x.vlambda.vadd(f,x.vlambda),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(h.rotational,f),f.mult(c,f),d.wlambda.vadd(f,d.wlambda)),x.invInertiaWorldSolve&&(x.invInertiaWorldSolve.vmult(u.rotational,f),f.mult(c,f),x.wlambda.vadd(f,x.wlambda))},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(v,N,ct){N.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(o,t,i){p.call(this,o,t,-i,i),this.ri=new e,this.rj=new e,this.t=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e;s.prototype.computeB=function(o){this.a;var t=this.b;this.bi,this.bj;var i=this.ri,n=this.rj,a=r,c=l,h=this.t;i.cross(h,a),n.cross(h,c);var u=this.jacobianElementA,d=this.jacobianElementB;h.negate(u.spatial),a.negate(u.rotational),d.spatial.copy(h),d.rotational.copy(c);var x=this.computeGW(),f=this.computeGiMf(),b=-x*t-o*f;return b}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(v,N,ct){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.maxAngle=Math.PI/2}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(o){var t=this.a,i=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.maxAngle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),U=-x*t-f*i-o*b;return U}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(v,N,ct){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(r,l,o){o=typeof o<"u"?o:1e6,e.call(this,r,l,-o,o),this.axisA=new p,this.axisB=new p,this.targetVelocity=0}s.prototype=new e,s.prototype.constructor=s,s.prototype.computeB=function(r){this.a;var l=this.b;this.bi,this.bj;var o=this.axisA,t=this.axisB,i=this.jacobianElementA,n=this.jacobianElementB;i.rotational.copy(o),t.negate(n.rotational);var a=this.computeGW()-this.targetVelocity,c=this.computeGiMf(),h=-a*l-r*c;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(v,N,ct){var p=v("../utils/Utils");N.exports=e;function e(s,r,l){l=p.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[s,r],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(v,N,ct){N.exports=p;function p(e){var s="";e=e||{},typeof e=="string"?(s=e,e={}):typeof e=="object"&&(s=""),this.name=s,this.id=p.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}p.idCounter=0},{}],26:[function(v,N,ct){N.exports=e;var p=v("./Vec3");function e(){this.spatial=new p,this.rotational=new p}e.prototype.multiplyElement=function(s){return s.spatial.dot(this.spatial)+s.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(s,r){return s.dot(this.spatial)+r.dot(this.rotational)}},{"./Vec3":30}],27:[function(v,N,ct){N.exports=e;var p=v("./Vec3");function e(s){s?this.elements=s:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var s=this.elements;s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1},e.prototype.setZero=function(){var s=this.elements;s[0]=0,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=0,s[6]=0,s[7]=0,s[8]=0},e.prototype.setTrace=function(s){var r=this.elements;r[0]=s.x,r[4]=s.y,r[8]=s.z},e.prototype.getTrace=function(r){var r=r||new p,l=this.elements;r.x=l[0],r.y=l[4],r.z=l[8]},e.prototype.vmult=function(s,r){r=r||new p;var l=this.elements,o=s.x,t=s.y,i=s.z;return r.x=l[0]*o+l[1]*t+l[2]*i,r.y=l[3]*o+l[4]*t+l[5]*i,r.z=l[6]*o+l[7]*t+l[8]*i,r},e.prototype.smult=function(s){for(var r=0;r<this.elements.length;r++)this.elements[r]*=s},e.prototype.mmult=function(s,r){for(var l=r||new e,o=0;o<3;o++)for(var t=0;t<3;t++){for(var i=0,n=0;n<3;n++)i+=s.elements[o+n*3]*this.elements[n+t*3];l.elements[o+t*3]=i}return l},e.prototype.scale=function(s,r){r=r||new e;for(var l=this.elements,o=r.elements,t=0;t!==3;t++)o[3*t+0]=s.x*l[3*t+0],o[3*t+1]=s.y*l[3*t+1],o[3*t+2]=s.z*l[3*t+2];return r},e.prototype.solve=function(s,r){r=r||new p;for(var l=3,o=4,t=[],i=0;i<l*o;i++)t.push(0);var i,n;for(i=0;i<3;i++)for(n=0;n<3;n++)t[i+o*n]=this.elements[i+3*n];t[3+4*0]=s.x,t[3+4*1]=s.y,t[3+4*2]=s.z;var a=3,c=a,h,u=4,d;do{if(i=c-a,t[i+o*i]===0){for(n=i+1;n<c;n++)if(t[i+o*n]!==0){h=u;do d=u-h,t[d+o*i]+=t[d+o*n];while(--h);break}}if(t[i+o*i]!==0)for(n=i+1;n<c;n++){var x=t[i+o*n]/t[i+o*i];h=u;do d=u-h,t[d+o*n]=d<=i?0:t[d+o*n]-t[d+o*i]*x;while(--h)}}while(--a);if(r.z=t[2*o+3]/t[2*o+2],r.y=(t[1*o+3]-t[1*o+2]*r.z)/t[1*o+1],r.x=(t[0*o+3]-t[0*o+2]*r.z-t[0*o+1]*r.y)/t[0*o+0],isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||r.x===1/0||r.y===1/0||r.z===1/0)throw"Could not solve equation! Got x=["+r.toString()+"], b=["+s.toString()+"], A=["+this.toString()+"]";return r},e.prototype.e=function(s,r,l){if(l===void 0)return this.elements[r+3*s];this.elements[r+3*s]=l},e.prototype.copy=function(s){for(var r=0;r<s.elements.length;r++)this.elements[r]=s.elements[r];return this},e.prototype.toString=function(){for(var s="",r=",",l=0;l<9;l++)s+=this.elements[l]+r;return s},e.prototype.reverse=function(s){s=s||new e;for(var r=3,l=6,o=[],t=0;t<r*l;t++)o.push(0);var t,i;for(t=0;t<3;t++)for(i=0;i<3;i++)o[t+l*i]=this.elements[t+3*i];o[3+6*0]=1,o[3+6*1]=0,o[3+6*2]=0,o[4+6*0]=0,o[4+6*1]=1,o[4+6*2]=0,o[5+6*0]=0,o[5+6*1]=0,o[5+6*2]=1;var n=3,a=n,c,h=l,u;do{if(t=a-n,o[t+l*t]===0){for(i=t+1;i<a;i++)if(o[t+l*i]!==0){c=h;do u=h-c,o[u+l*t]+=o[u+l*i];while(--c);break}}if(o[t+l*t]!==0)for(i=t+1;i<a;i++){var d=o[t+l*i]/o[t+l*t];c=h;do u=h-c,o[u+l*i]=u<=t?0:o[u+l*i]-o[u+l*t]*d;while(--c)}}while(--n);t=2;do{i=t-1;do{var d=o[t+l*i]/o[t+l*t];c=l;do u=l-c,o[u+l*i]=o[u+l*i]-o[u+l*t]*d;while(--c)}while(i--)}while(--t);t=2;do{var d=1/o[t+l*t];c=l;do u=l-c,o[u+l*t]=o[u+l*t]*d;while(--c)}while(t--);t=2;do{i=2;do{if(u=o[r+i+l*t],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";s.e(t,i,u)}while(i--)}while(t--);return s},e.prototype.setRotationFromQuaternion=function(s){var r=s.x,l=s.y,o=s.z,t=s.w,i=r+r,n=l+l,a=o+o,c=r*i,h=r*n,u=r*a,d=l*n,x=l*a,f=o*a,b=t*i,U=t*n,rt=t*a,P=this.elements;return P[3*0+0]=1-(d+f),P[3*0+1]=h-rt,P[3*0+2]=u+U,P[3*1+0]=h+rt,P[3*1+1]=1-(c+f),P[3*1+2]=x-b,P[3*2+0]=u-U,P[3*2+1]=x+b,P[3*2+2]=1-(c+d),this},e.prototype.transpose=function(s){s=s||new e;for(var r=s.elements,l=this.elements,o=0;o!==3;o++)for(var t=0;t!==3;t++)r[3*o+t]=l[3*t+o];return s}},{"./Vec3":30}],28:[function(v,N,ct){N.exports=e;var p=v("./Vec3");function e(i,n,a,c){this.x=i!==void 0?i:0,this.y=n!==void 0?n:0,this.z=a!==void 0?a:0,this.w=c!==void 0?c:1}e.prototype.set=function(i,n,a,c){this.x=i,this.y=n,this.z=a,this.w=c},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(i,n){var a=Math.sin(n*.5);this.x=i.x*a,this.y=i.y*a,this.z=i.z*a,this.w=Math.cos(n*.5)},e.prototype.toAxisAngle=function(i){i=i||new p,this.normalize();var n=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return a<.001?(i.x=this.x,i.y=this.y,i.z=this.z):(i.x=this.x/a,i.y=this.y/a,i.z=this.z/a),[i,n]};var s=new p,r=new p;e.prototype.setFromVectors=function(i,n){if(i.isAntiparallelTo(n)){var a=s,c=r;i.tangents(a,c),this.setFromAxisAngle(a,Math.PI)}else{var h=i.cross(n);this.x=h.x,this.y=h.y,this.z=h.z,this.w=Math.sqrt(Math.pow(i.norm(),2)*Math.pow(n.norm(),2))+i.dot(n),this.normalize()}};var l=new p,o=new p,t=new p;e.prototype.mult=function(i,n){n=n||new e;var a=this.w,c=l,h=o,u=t;return c.set(this.x,this.y,this.z),h.set(i.x,i.y,i.z),n.w=a*i.w-c.dot(h),c.cross(h,u),n.x=a*h.x+i.w*c.x+u.x,n.y=a*h.y+i.w*c.y+u.y,n.z=a*h.z+i.w*c.z+u.z,n},e.prototype.inverse=function(i){var n=this.x,a=this.y,c=this.z,h=this.w;i=i||new e,this.conjugate(i);var u=1/(n*n+a*a+c*c+h*h);return i.x*=u,i.y*=u,i.z*=u,i.w*=u,i},e.prototype.conjugate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i.w=this.w,i},e.prototype.normalize=function(){var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(i=1/i,this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.normalizeFast=function(){var i=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.vmult=function(i,n){n=n||new p;var a=i.x,c=i.y,h=i.z,u=this.x,d=this.y,x=this.z,f=this.w,b=f*a+d*h-x*c,U=f*c+x*a-u*h,rt=f*h+u*c-d*a,P=-u*a-d*c-x*h;return n.x=b*f+P*-u+U*-x-rt*-d,n.y=U*f+P*-d+rt*-u-b*-x,n.z=rt*f+P*-x+b*-d-U*-u,n},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},e.prototype.toEuler=function(i,n){n=n||"YZX";var a,c,h,u=this.x,d=this.y,x=this.z,f=this.w;switch(n){case"YZX":var b=u*d+x*f;if(b>.499&&(a=2*Math.atan2(u,f),c=Math.PI/2,h=0),b<-.499&&(a=-2*Math.atan2(u,f),c=-Math.PI/2,h=0),isNaN(a)){var U=u*u,rt=d*d,P=x*x;a=Math.atan2(2*d*f-2*u*x,1-2*rt-2*P),c=Math.asin(2*b),h=Math.atan2(2*u*f-2*d*x,1-2*U-2*P)}break;default:throw new Error("Euler order "+n+" not supported yet.")}i.y=a,i.z=c,i.x=h},e.prototype.setFromEuler=function(i,n,a,c){c=c||"XYZ";var h=Math.cos(i/2),u=Math.cos(n/2),d=Math.cos(a/2),x=Math.sin(i/2),f=Math.sin(n/2),b=Math.sin(a/2);return c==="XYZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="YXZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="ZXY"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="ZYX"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="YZX"?(this.x=x*u*d+h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d-x*f*b):c==="XZY"&&(this.x=x*u*d-h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d+x*f*b),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(v,N,ct){var p=v("./Vec3"),e=v("./Quaternion");N.exports=s;function s(l){l=l||{},this.position=new p,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var r=new e;s.pointToLocalFrame=function(l,o,t,n){var n=n||new p;return t.vsub(l,n),o.conjugate(r),r.vmult(n,n),n},s.prototype.pointToLocal=function(l,o){return s.pointToLocalFrame(this.position,this.quaternion,l,o)},s.pointToWorldFrame=function(l,o,t,n){var n=n||new p;return o.vmult(t,n),n.vadd(l,n),n},s.prototype.pointToWorld=function(l,o){return s.pointToWorldFrame(this.position,this.quaternion,l,o)},s.prototype.vectorToWorldFrame=function(l,t){var t=t||new p;return this.quaternion.vmult(l,t),t},s.vectorToWorldFrame=function(l,o,t){return l.vmult(o,t),t},s.vectorToLocalFrame=function(l,o,t,n){var n=n||new p;return o.w*=-1,o.vmult(t,n),o.w*=-1,n}},{"./Quaternion":28,"./Vec3":30}],30:[function(v,N,ct){N.exports=e;var p=v("./Mat3");function e(o,t,i){this.x=o||0,this.y=t||0,this.z=i||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(o,t){var i=o.x,n=o.y,a=o.z,c=this.x,h=this.y,u=this.z;return t=t||new e,t.x=h*a-u*n,t.y=u*i-c*a,t.z=c*n-h*i,t},e.prototype.set=function(o,t,i){return this.x=o,this.y=t,this.z=i,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(o,t){if(t)t.x=o.x+this.x,t.y=o.y+this.y,t.z=o.z+this.z;else return new e(this.x+o.x,this.y+o.y,this.z+o.z)},e.prototype.vsub=function(o,t){if(t)t.x=this.x-o.x,t.y=this.y-o.y,t.z=this.z-o.z;else return new e(this.x-o.x,this.y-o.y,this.z-o.z)},e.prototype.crossmat=function(){return new p([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var o=this.x,t=this.y,i=this.z,n=Math.sqrt(o*o+t*t+i*i);if(n>0){var a=1/n;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return n},e.prototype.unit=function(o){o=o||new e;var t=this.x,i=this.y,n=this.z,a=Math.sqrt(t*t+i*i+n*n);return a>0?(a=1/a,o.x=t*a,o.y=i*a,o.z=n*a):(o.x=1,o.y=0,o.z=0),o},e.prototype.norm=function(){var o=this.x,t=this.y,i=this.z;return Math.sqrt(o*o+t*t+i*i)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(o){var t=this.x,i=this.y,n=this.z,a=o.x,c=o.y,h=o.z;return Math.sqrt((a-t)*(a-t)+(c-i)*(c-i)+(h-n)*(h-n))},e.prototype.distanceSquared=function(o){var t=this.x,i=this.y,n=this.z,a=o.x,c=o.y,h=o.z;return(a-t)*(a-t)+(c-i)*(c-i)+(h-n)*(h-n)},e.prototype.mult=function(o,t){t=t||new e;var i=this.x,n=this.y,a=this.z;return t.x=o*i,t.y=o*n,t.z=o*a,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(o){return this.x*o.x+this.y*o.y+this.z*o.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o};var s=new e,r=new e;e.prototype.tangents=function(o,t){var i=this.norm();if(i>0){var n=s,a=1/i;n.set(this.x*a,this.y*a,this.z*a);var c=r;Math.abs(n.x)<.9?(c.set(1,0,0),n.cross(c,o)):(c.set(0,1,0),n.cross(c,o)),n.cross(o,t)}else o.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this},e.prototype.lerp=function(o,t,i){var n=this.x,a=this.y,c=this.z;i.x=n+(o.x-n)*t,i.y=a+(o.y-a)*t,i.z=c+(o.z-c)*t},e.prototype.almostEquals=function(o,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-o.x)>t||Math.abs(this.y-o.y)>t||Math.abs(this.z-o.z)>t)},e.prototype.almostZero=function(o){return o===void 0&&(o=1e-6),!(Math.abs(this.x)>o||Math.abs(this.y)>o||Math.abs(this.z)>o)};var l=new e;e.prototype.isAntiparallelTo=function(o,t){return this.negate(l),l.almostEquals(o,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(v,N,ct){N.exports=t;var p=v("../utils/EventTarget");v("../shapes/Shape");var e=v("../math/Vec3"),s=v("../math/Mat3"),r=v("../math/Quaternion");v("../material/Material");var l=v("../collision/AABB"),o=v("../shapes/Box");function t(B){B=B||{},p.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof B.collisionFilterGroup=="number"?B.collisionFilterGroup:1,this.collisionFilterMask=typeof B.collisionFilterMask=="number"?B.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,B.position&&this.position.copy(B.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,B.velocity&&this.velocity.copy(B.velocity),this.initVelocity=new e,this.force=new e;var T=typeof B.mass=="number"?B.mass:0;this.mass=T,this.invMass=T>0?1/T:0,this.material=B.material||null,this.linearDamping=typeof B.linearDamping=="number"?B.linearDamping:.01,this.type=T<=0?t.STATIC:t.DYNAMIC,typeof B.type==typeof t.STATIC&&(this.type=B.type),this.allowSleep=typeof B.allowSleep<"u"?B.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof B.sleepSpeedLimit<"u"?B.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof B.sleepTimeLimit<"u"?B.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new r,B.quaternion&&this.quaternion.copy(B.quaternion),this.initQuaternion=new r,this.angularVelocity=new e,B.angularVelocity&&this.angularVelocity.copy(B.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new s,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new s,this.fixedRotation=typeof B.fixedRotation<"u"?B.fixedRotation:!1,this.angularDamping=typeof B.angularDamping<"u"?B.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,B.shape&&this.addShape(B.shape),this.updateMassProperties()}t.prototype=new p,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var B=this.sleepState;this.sleepState=0,B===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(B){if(this.allowSleep){var T=this.sleepState,F=this.velocity.norm2()+this.angularVelocity.norm2(),K=Math.pow(this.sleepSpeedLimit,2);T===t.AWAKE&&F<K?(this.sleepState=t.SLEEPY,this.timeLastSleepy=B,this.dispatchEvent(t.sleepyEvent)):T===t.SLEEPY&&F>K?this.wakeUp():T===t.SLEEPY&&B-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(B,F){var F=F||new e;return B.vsub(this.position,F),this.quaternion.conjugate().vmult(F,F),F},t.prototype.vectorToLocalFrame=function(B,F){var F=F||new e;return this.quaternion.conjugate().vmult(B,F),F},t.prototype.pointToWorldFrame=function(B,F){var F=F||new e;return this.quaternion.vmult(B,F),F.vadd(this.position,F),F},t.prototype.vectorToWorldFrame=function(B,F){var F=F||new e;return this.quaternion.vmult(B,F),F};var i=new e,n=new r;t.prototype.addShape=function(B,T,F){var K=new e,Z=new r;return T&&K.copy(T),F&&Z.copy(F),this.shapes.push(B),this.shapeOffsets.push(K),this.shapeOrientations.push(Z),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var B=this.shapes,T=this.shapeOffsets,F=B.length,K=0,Z=0;Z!==F;Z++){var ut=B[Z];ut.updateBoundingSphereRadius();var R=T[Z].norm(),A=ut.boundingSphereRadius;R+A>K&&(K=R+A)}this.boundingRadius=K};var a=new l;t.prototype.computeAABB=function(){for(var B=this.shapes,T=this.shapeOffsets,F=this.shapeOrientations,K=B.length,Z=i,ut=n,R=this.quaternion,A=this.aabb,X=a,q=0;q!==K;q++){var g=B[q];F[q].mult(R,ut),ut.vmult(T[q],Z),Z.vadd(this.position,Z),g.calculateWorldAABB(Z,ut,X.lowerBound,X.upperBound),q===0?A.copy(X):A.extend(X)}this.aabbNeedsUpdate=!1};var c=new s,h=new s;new s,t.prototype.updateInertiaWorld=function(B){var T=this.invInertia;if(!(T.x===T.y&&T.y===T.z&&!B)){var F=c,K=h;F.setRotationFromQuaternion(this.quaternion),F.transpose(K),F.scale(T,F),F.mmult(K,this.invInertiaWorld)}};var u=new e,d=new e;t.prototype.applyForce=function(B,T){if(this.type===t.DYNAMIC){var F=u;T.vsub(this.position,F);var K=d;F.cross(B,K),this.force.vadd(B,this.force),this.torque.vadd(K,this.torque)}};var x=new e,f=new e;t.prototype.applyLocalForce=function(B,T){if(this.type===t.DYNAMIC){var F=x,K=f;this.vectorToWorldFrame(B,F),this.pointToWorldFrame(T,K),this.applyForce(F,K)}};var b=new e,U=new e,rt=new e;t.prototype.applyImpulse=function(B,T){if(this.type===t.DYNAMIC){var F=b;T.vsub(this.position,F);var K=U;K.copy(B),K.mult(this.invMass,K),this.velocity.vadd(K,this.velocity);var Z=rt;F.cross(B,Z),this.invInertiaWorld.vmult(Z,Z),this.angularVelocity.vadd(Z,this.angularVelocity)}};var P=new e,k=new e;t.prototype.applyLocalImpulse=function(B,T){if(this.type===t.DYNAMIC){var F=P,K=k;this.vectorToWorldFrame(B,F),this.pointToWorldFrame(T,K),this.applyImpulse(F,K)}};var M=new e;t.prototype.updateMassProperties=function(){var B=M;this.invMass=this.mass>0?1/this.mass:0;var T=this.inertia,F=this.fixedRotation;this.computeAABB(),B.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),o.calculateInertia(B,this.mass,T),this.invInertia.set(T.x>0&&!F?1/T.x:0,T.y>0&&!F?1/T.y:0,T.z>0&&!F?1/T.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(B,T){var F=new e;return B.vsub(this.position,F),this.angularVelocity.cross(F,T),this.velocity.vadd(T,T),T}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(v,N,ct){v("./Body");var p=v("../math/Vec3"),e=v("../math/Quaternion");v("../collision/RaycastResult");var s=v("../collision/Ray"),r=v("../objects/WheelInfo");N.exports=l;function l(R){this.chassisBody=R.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof R.indexRightAxis<"u"?R.indexRightAxis:1,this.indexForwardAxis=typeof R.indexForwardAxis<"u"?R.indexForwardAxis:0,this.indexUpAxis=typeof R.indexUpAxis<"u"?R.indexUpAxis:2}new p,new p,new p;var o=new p,t=new p,i=new p;new s,l.prototype.addWheel=function(R){R=R||{};var A=new r(R),X=this.wheelInfos.length;return this.wheelInfos.push(A),X},l.prototype.setSteeringValue=function(R,A){var X=this.wheelInfos[A];X.steering=R},new p,l.prototype.applyEngineForce=function(R,A){this.wheelInfos[A].engineForce=R},l.prototype.setBrake=function(R,A){this.wheelInfos[A].brake=R},l.prototype.addToWorld=function(R){this.constraints,R.add(this.chassisBody);var A=this;this.preStepCallback=function(){A.updateVehicle(R.dt)},R.addEventListener("preStep",this.preStepCallback),this.world=R},l.prototype.getVehicleAxisWorld=function(R,A){A.set(R===0?1:0,R===1?1:0,R===2?1:0),this.chassisBody.vectorToWorldFrame(A,A)},l.prototype.updateVehicle=function(R){for(var A=this.wheelInfos,X=A.length,q=this.chassisBody,g=0;g<X;g++)this.updateWheelTransform(g);this.currentVehicleSpeedKmHour=3.6*q.velocity.norm();var z=new p;this.getVehicleAxisWorld(this.indexForwardAxis,z),z.dot(q.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var g=0;g<X;g++)this.castRay(A[g]);this.updateSuspension(R);for(var w=new p,m=new p,g=0;g<X;g++){var y=A[g],C=y.suspensionForce;C>y.maxSuspensionForce&&(C=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(C*R,w),y.raycastResult.hitPointWorld.vsub(q.position,m),q.applyImpulse(w,y.raycastResult.hitPointWorld)}this.updateFriction(R);var G=new p,W=new p,E=new p;for(g=0;g<X;g++){var y=A[g];q.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,E);var L=1;switch(this.indexUpAxis){case 1:L=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,W);var _=W.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(_,G),W.vsub(G,W);var pt=W.dot(E);y.deltaRotation=L*pt*R/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*R),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(R){for(var A=this.chassisBody,X=A.mass,q=this.wheelInfos,g=q.length,z=0;z<g;z++){var w=q[z];if(w.isInContact){var m,y=w.suspensionRestLength,C=w.suspensionLength,G=y-C;m=w.suspensionStiffness*G*w.clippedInvContactDotSuspension;var W=w.suspensionRelativeVelocity,E;W<0?E=w.dampingCompression:E=w.dampingRelaxation,m-=E*W,w.suspensionForce=m*X,w.suspensionForce<0&&(w.suspensionForce=0)}else w.suspensionForce=0}},l.prototype.removeFromWorld=function(R){this.constraints,R.remove(this.chassisBody),R.removeEventListener("preStep",this.preStepCallback),this.world=null};var n=new p,a=new p;l.prototype.castRay=function(R){var A=n,X=a;this.updateWheelTransformWorld(R);var q=this.chassisBody,g=-1,z=R.suspensionRestLength+R.radius;R.directionWorld.scale(z,A);var w=R.chassisConnectionPointWorld;w.vadd(A,X);var m=R.raycastResult;m.reset();var y=q.collisionResponse;q.collisionResponse=!1,this.world.rayTest(w,X,m),q.collisionResponse=y;var C=m.body;if(R.raycastResult.groundObject=0,C){g=m.distance,R.raycastResult.hitNormalWorld=m.hitNormalWorld,R.isInContact=!0;var G=m.distance;R.suspensionLength=G-R.radius;var W=R.suspensionRestLength-R.maxSuspensionTravel,E=R.suspensionRestLength+R.maxSuspensionTravel;R.suspensionLength<W&&(R.suspensionLength=W),R.suspensionLength>E&&(R.suspensionLength=E,R.raycastResult.reset());var L=R.raycastResult.hitNormalWorld.dot(R.directionWorld),_=new p;q.getVelocityAtWorldPoint(R.raycastResult.hitPointWorld,_);var pt=R.raycastResult.hitNormalWorld.dot(_);if(L>=-.1)R.suspensionRelativeVelocity=0,R.clippedInvContactDotSuspension=1/.1;else{var st=-1/L;R.suspensionRelativeVelocity=pt*st,R.clippedInvContactDotSuspension=st}}else R.suspensionLength=R.suspensionRestLength+0*R.maxSuspensionTravel,R.suspensionRelativeVelocity=0,R.directionWorld.scale(-1,R.raycastResult.hitNormalWorld),R.clippedInvContactDotSuspension=1;return g},l.prototype.updateWheelTransformWorld=function(R){R.isInContact=!1;var A=this.chassisBody;A.pointToWorldFrame(R.chassisConnectionPointLocal,R.chassisConnectionPointWorld),A.vectorToWorldFrame(R.directionLocal,R.directionWorld),A.vectorToWorldFrame(R.axleLocal,R.axleWorld)},l.prototype.updateWheelTransform=function(R){var A=o,X=t,q=i,g=this.wheelInfos[R];this.updateWheelTransformWorld(g),g.directionLocal.scale(-1,A),X.copy(g.axleLocal),A.cross(X,q),q.normalize(),X.normalize();var z=g.steering,w=new e;w.setFromAxisAngle(A,z);var m=new e;m.setFromAxisAngle(X,g.rotation);var y=g.worldTransform.quaternion;this.chassisBody.quaternion.mult(w,y),y.mult(m,y),y.normalize();var C=g.worldTransform.position;C.copy(g.directionWorld),C.scale(g.suspensionLength,C),C.vadd(g.chassisConnectionPointWorld,C)};var c=[new p(1,0,0),new p(0,1,0),new p(0,0,1)];l.prototype.getWheelTransformWorld=function(R){return this.wheelInfos[R].worldTransform};var h=new p,u=[],d=[],x=1;l.prototype.updateFriction=function(R){for(var A=h,X=this.wheelInfos,q=X.length,g=this.chassisBody,z=d,w=u,m=0;m<q;m++){var y=X[m],C=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,z[m]||(z[m]=new p),w[m]||(w[m]=new p)}for(var m=0;m<q;m++){var y=X[m],C=y.raycastResult.body;if(C){var G=w[m],W=this.getWheelTransformWorld(m);W.vectorToWorldFrame(c[this.indexRightAxis],G);var E=y.raycastResult.hitNormalWorld,L=G.dot(E);E.scale(L,A),G.vsub(A,G),G.normalize(),E.cross(G,z[m]),z[m].normalize(),y.sideImpulse=ut(g,y.raycastResult.hitPointWorld,C,y.raycastResult.hitPointWorld,G),y.sideImpulse*=x}}var _=1,pt=.5;this.sliding=!1;for(var m=0;m<q;m++){var y=X[m],C=y.raycastResult.body,st=0;if(y.slipInfo=1,C){var at=0,O=y.brake?y.brake:at;st=rt(g,C,y.raycastResult.hitPointWorld,z[m],O),st+=y.engineForce*R;var Q=O/st;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,C){y.skidInfo=1;var bt=y.suspensionForce*R*y.frictionSlip,ft=bt,Rt=bt*ft;y.forwardImpulse=st;var ht=y.forwardImpulse*pt,St=y.sideImpulse*_,zt=ht*ht+St*St;if(y.sliding=!1,zt>Rt){this.sliding=!0,y.sliding=!0;var Q=bt/Math.sqrt(zt);y.skidInfo*=Q}}}if(this.sliding)for(var m=0;m<q;m++){var y=X[m];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var m=0;m<q;m++){var y=X[m],Mt=new p;if(Mt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Vt=new p;z[m].scale(y.forwardImpulse,Vt),g.applyImpulse(Vt,Mt)}if(y.sideImpulse!==0){var C=y.raycastResult.body,At=new p;At.copy(y.raycastResult.hitPointWorld);var Ft=new p;w[m].scale(y.sideImpulse,Ft),g.pointToLocalFrame(Mt,Mt),Mt["xyz"[this.indexUpAxis]]*=y.rollInfluence,g.pointToWorldFrame(Mt,Mt),g.applyImpulse(Ft,Mt),Ft.scale(-1,Ft),C.applyImpulse(Ft,At)}}};var f=new p,b=new p,U=new p;function rt(R,A,X,q,g){var z=0,w=X,m=f,y=b,C=U;R.getVelocityAtWorldPoint(w,m),A.getVelocityAtWorldPoint(w,y),m.vsub(y,C);var G=q.dot(C),W=T(R,X,q),E=T(A,X,q),L=1,_=L/(W+E);return z=-G*_,g<z&&(z=g),z<-g&&(z=-g),z}var P=new p,k=new p,M=new p,B=new p;function T(R,A,X){var q=P,g=k,z=M,w=B;return A.vsub(R.position,q),q.cross(X,g),R.invInertiaWorld.vmult(g,w),w.cross(q,z),R.invMass+X.dot(z)}var F=new p,K=new p,Z=new p;function ut(R,A,X,q,g,L){var w=g.norm2();if(w>1.1)return 0;var m=F,y=K,C=Z;R.getVelocityAtWorldPoint(A,m),X.getVelocityAtWorldPoint(q,y),m.vsub(y,C);var G=g.dot(C),W=.2,E=1/(R.invMass+X.invMass),L=-W*G*E;return L}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(v,N,ct){var p=v("./Body"),e=v("../shapes/Sphere"),s=v("../shapes/Box"),r=v("../math/Vec3"),l=v("../constraints/HingeConstraint");N.exports=o;function o(n){if(this.wheelBodies=[],this.coordinateSystem=typeof n.coordinateSystem>"u"?new r(1,2,3):n.coordinateSystem.clone(),this.chassisBody=n.chassisBody,!this.chassisBody){var a=new s(new r(5,2,.5));this.chassisBody=new p(1,a)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}o.prototype.addWheel=function(n){n=n||{};var a=n.body;a||(a=new p(1,new e(1.2))),this.wheelBodies.push(a),this.wheelForces.push(0),new r;var c=typeof n.position<"u"?n.position.clone():new r,h=new r;this.chassisBody.pointToWorldFrame(c,h),a.position.set(h.x,h.y,h.z);var u=typeof n.axis<"u"?n.axis.clone():new r(0,1,0);this.wheelAxes.push(u);var d=new l(this.chassisBody,a,{pivotA:c,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(d),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(n,a){var c=this.wheelAxes[a],h=Math.cos(n),u=Math.sin(n),d=c.x,x=c.y;this.constraints[a].axisA.set(h*d-u*x,u*d+h*x,0)},o.prototype.setMotorSpeed=function(n,a){var c=this.constraints[a];c.enableMotor(),c.motorTargetVelocity=n},o.prototype.disableMotor=function(n){var a=this.constraints[n];a.disableMotor()};var t=new r;o.prototype.setWheelForce=function(n,a){this.wheelForces[a]=n},o.prototype.applyWheelForce=function(n,a){var c=this.wheelAxes[a],h=this.wheelBodies[a],u=h.torque;c.scale(n,t),h.vectorToWorldFrame(t,t),u.vadd(t,u)},o.prototype.addToWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.add(c[h]);for(var h=0;h<a.length;h++)n.addConstraint(a[h]);n.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var n=this.wheelForces,a=0;a<n.length;a++)this.applyWheelForce(n[a],a)},o.prototype.removeFromWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.remove(c[h]);for(var h=0;h<a.length;h++)n.removeConstraint(a[h])};var i=new r;o.prototype.getWheelSpeed=function(n){var a=this.wheelAxes[n],c=this.wheelBodies[n],h=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(a,i),h.dot(i)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(v,N,ct){N.exports=e,v("../shapes/Shape");var p=v("../math/Vec3");v("../math/Quaternion"),v("../shapes/Particle"),v("../objects/Body"),v("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(a){var c=this.particles.indexOf(a);c!==-1&&(this.particles.splice(c,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new p;e.prototype.getNeighbors=function(a,c){for(var h=this.particles.length,u=a.id,d=this.smoothingRadius*this.smoothingRadius,x=s,f=0;f!==h;f++){var b=this.particles[f];b.position.vsub(a.position,x),u!==b.id&&x.norm2()<d&&c.push(b)}};var r=new p,l=new p,o=new p,t=new p,i=new p,n=new p;e.prototype.update=function(){for(var a=this.particles.length,c=r,h=this.speedOfSound,u=this.eps,d=0;d!==a;d++){var x=this.particles[d],f=this.neighbors[d];f.length=0,this.getNeighbors(x,f),f.push(this.particles[d]);for(var b=f.length,U=0,rt=0;rt!==b;rt++){x.position.vsub(f[rt].position,c);var P=c.norm(),k=this.w(P);U+=f[rt].mass*k}this.densities[d]=U,this.pressures[d]=h*h*(this.densities[d]-this.density)}for(var M=l,B=o,T=t,F=i,K=n,d=0;d!==a;d++){var Z=this.particles[d];M.set(0,0,0),B.set(0,0,0);for(var ut,R,f=this.neighbors[d],b=f.length,rt=0;rt!==b;rt++){var A=f[rt];Z.position.vsub(A.position,F);var X=F.norm();ut=-A.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+u)+this.pressures[rt]/(this.densities[rt]*this.densities[rt]+u)),this.gradw(F,T),T.mult(ut,T),M.vadd(T,M),A.velocity.vsub(Z.velocity,K),K.mult(1/(1e-4+this.densities[d]*this.densities[rt])*this.viscosity*A.mass,K),R=this.nablaw(X),K.mult(R,K),B.vadd(K,B)}B.mult(Z.mass,B),M.mult(Z.mass,M),Z.force.vadd(B,Z.force),Z.force.vadd(M,Z.force)}},e.prototype.w=function(a){var c=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(c,9))*Math.pow(c*c-a*a,3)},e.prototype.gradw=function(a,c){var h=a.norm(),u=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(u,9))*Math.pow(u*u-h*h,2),c)},e.prototype.nablaw=function(a){var c=this.smoothingRadius,h=945/(32*Math.PI*Math.pow(c,9))*(c*c-a*a)*(7*a*a-3*c*c);return h}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(v,N,ct){var p=v("../math/Vec3");N.exports=e;function e(d,x,f){f=f||{},this.restLength=typeof f.restLength=="number"?f.restLength:1,this.stiffness=f.stiffness||100,this.damping=f.damping||1,this.bodyA=d,this.bodyB=x,this.localAnchorA=new p,this.localAnchorB=new p,f.localAnchorA&&this.localAnchorA.copy(f.localAnchorA),f.localAnchorB&&this.localAnchorB.copy(f.localAnchorB),f.worldAnchorA&&this.setWorldAnchorA(f.worldAnchorA),f.worldAnchorB&&this.setWorldAnchorB(f.worldAnchorB)}e.prototype.setWorldAnchorA=function(d){this.bodyA.pointToLocalFrame(d,this.localAnchorA)},e.prototype.setWorldAnchorB=function(d){this.bodyB.pointToLocalFrame(d,this.localAnchorB)},e.prototype.getWorldAnchorA=function(d){this.bodyA.pointToWorldFrame(this.localAnchorA,d)},e.prototype.getWorldAnchorB=function(d){this.bodyB.pointToWorldFrame(this.localAnchorB,d)};var s=new p,r=new p,l=new p,o=new p,t=new p,i=new p,n=new p,a=new p,c=new p,h=new p,u=new p;e.prototype.applyForce=function(){var d=this.stiffness,x=this.damping,f=this.restLength,b=this.bodyA,U=this.bodyB,rt=s,P=r,k=l,M=o,B=u,T=t,F=i,K=n,Z=a,ut=c,R=h;this.getWorldAnchorA(T),this.getWorldAnchorB(F),T.vsub(b.position,K),F.vsub(U.position,Z),F.vsub(T,rt);var A=rt.norm();P.copy(rt),P.normalize(),U.velocity.vsub(b.velocity,k),U.angularVelocity.cross(Z,B),k.vadd(B,k),b.angularVelocity.cross(K,B),k.vsub(B,k),P.mult(-d*(A-f)-x*k.dot(P),M),b.force.vsub(M,b.force),U.force.vadd(M,U.force),K.cross(M,ut),Z.cross(M,R),b.torque.vsub(ut,b.torque),U.torque.vadd(R,U.torque)}},{"../math/Vec3":30}],36:[function(v,N,ct){var p=v("../math/Vec3"),e=v("../math/Transform"),s=v("../collision/RaycastResult"),r=v("../utils/Utils");N.exports=l;function l(i){i=r.defaults(i,{chassisConnectionPointLocal:new p,chassisConnectionPointWorld:new p,directionLocal:new p,directionWorld:new p,axleLocal:new p,axleWorld:new p,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=i.maxSuspensionTravel,this.customSlidingRotationalSpeed=i.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=i.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=i.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=i.chassisConnectionPointWorld.clone(),this.directionLocal=i.directionLocal.clone(),this.directionWorld=i.directionWorld.clone(),this.axleLocal=i.axleLocal.clone(),this.axleWorld=i.axleWorld.clone(),this.suspensionRestLength=i.suspensionRestLength,this.suspensionMaxLength=i.suspensionMaxLength,this.radius=i.radius,this.suspensionStiffness=i.suspensionStiffness,this.dampingCompression=i.dampingCompression,this.dampingRelaxation=i.dampingRelaxation,this.frictionSlip=i.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=i.rollInfluence,this.maxSuspensionForce=i.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=i.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new e,this.isInContact=!1}var t=new p,o=new p,t=new p;l.prototype.updateWheel=function(i){var n=this.raycastResult;if(this.isInContact){var a=n.hitNormalWorld.dot(n.directionWorld);n.hitPointWorld.vsub(i.position,o),i.getVelocityAtWorldPoint(o,t);var c=n.hitNormalWorld.dot(t);if(a>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var h=-1/a;this.suspensionRelativeVelocity=c*h,this.clippedInvContactDotSuspension=h}}else n.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,n.directionWorld.scale(-1,n.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(v,N,ct){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3"),s=v("./ConvexPolyhedron");function r(t){p.call(this),this.type=p.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,a=e,c=[new a(-t,-i,-n),new a(t,-i,-n),new a(t,i,-n),new a(-t,i,-n),new a(-t,-i,n),new a(t,-i,n),new a(t,i,n),new a(-t,i,n)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new a(0,0,1),new a(0,1,0),new a(1,0,0);var u=new s(c,h);this.convexPolyhedronRepresentation=u,u.material=this.material},r.prototype.calculateLocalInertia=function(t,i){return i=i||new e,r.calculateInertia(this.halfExtents,t,i),i},r.calculateInertia=function(t,i,n){var a=t;n.x=1/12*i*(2*a.y*2*a.y+2*a.z*2*a.z),n.y=1/12*i*(2*a.x*2*a.x+2*a.z*2*a.z),n.z=1/12*i*(2*a.y*2*a.y+2*a.x*2*a.x)},r.prototype.getSideNormals=function(t,i){var n=t,a=this.halfExtents;if(n[0].set(a.x,0,0),n[1].set(0,a.y,0),n[2].set(0,0,a.z),n[3].set(-a.x,0,0),n[4].set(0,-a.y,0),n[5].set(0,0,-a.z),i!==void 0)for(var c=0;c!==n.length;c++)i.vmult(n[c],n[c]);return n},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,r.prototype.forEachWorldCorner=function(t,i,n){for(var a=this.halfExtents,c=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],h=0;h<c.length;h++)l.set(c[h][0],c[h][1],c[h][2]),i.vmult(l,l),t.vadd(l,l),n(l.x,l.y,l.z)};var o=[new e,new e,new e,new e,new e,new e,new e,new e];r.prototype.calculateWorldAABB=function(t,i,n,a){var c=this.halfExtents;o[0].set(c.x,c.y,c.z),o[1].set(-c.x,c.y,c.z),o[2].set(-c.x,-c.y,c.z),o[3].set(-c.x,-c.y,-c.z),o[4].set(c.x,-c.y,-c.z),o[5].set(c.x,c.y,-c.z),o[6].set(-c.x,c.y,-c.z),o[7].set(c.x,-c.y,c.z);var h=o[0];i.vmult(h,h),t.vadd(h,h),a.copy(h),n.copy(h);for(var u=1;u<8;u++){var h=o[u];i.vmult(h,h),t.vadd(h,h);var d=h.x,x=h.y,f=h.z;d>a.x&&(a.x=d),x>a.y&&(a.y=x),f>a.z&&(a.z=f),d<n.x&&(n.x=d),x<n.y&&(n.y=x),f<n.z&&(n.z=f)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(v,N,ct){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform");function r(g,z,w){p.call(this),this.type=p.types.CONVEXPOLYHEDRON,this.vertices=g||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=z||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=w?w.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r;var l=new e;r.prototype.computeEdges=function(){var g=this.faces,z=this.vertices;z.length;var w=this.uniqueEdges;w.length=0;for(var m=l,y=0;y!==g.length;y++)for(var C=g[y],G=C.length,W=0;W!==G;W++){var E=(W+1)%G;z[C[W]].vsub(z[C[E]],m),m.normalize();for(var L=!1,_=0;_!==w.length;_++)if(w[_].almostEquals(m)||w[_].almostEquals(m)){L=!0;break}L||w.push(m.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var z=0;z<this.faces[g].length;z++)if(!this.vertices[this.faces[g][z]])throw new Error("Vertex "+this.faces[g][z]+" not found!");var w=this.faceNormals[g]||new e;this.getFaceNormal(g,w),w.negate(w),this.faceNormals[g]=w;var m=this.vertices[this.faces[g][0]];if(w.dot(m)<0){console.error(".faceNormals["+g+"] = Vec3("+w.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var z=0;z<this.faces[g].length;z++)console.warn(".vertices["+this.faces[g][z]+"] = Vec3("+this.vertices[this.faces[g][z]].toString()+")")}}};var o=new e,t=new e;r.computeNormal=function(g,z,w,m){z.vsub(g,t),w.vsub(z,o),o.cross(t,m),m.isZero()||m.normalize()},r.prototype.getFaceNormal=function(g,z){var w=this.faces[g],m=this.vertices[w[0]],y=this.vertices[w[1]],C=this.vertices[w[2]];return r.computeNormal(m,y,C,z)};var i=new e;r.prototype.clipAgainstHull=function(g,z,w,m,y,C,G,W,E){for(var L=i,_=-1,pt=-Number.MAX_VALUE,st=0;st<w.faces.length;st++){L.copy(w.faceNormals[st]),y.vmult(L,L);var at=L.dot(C);at>pt&&(pt=at,_=st)}for(var O=[],Q=w.faces[_],bt=Q.length,ft=0;ft<bt;ft++){var Rt=w.vertices[Q[ft]],ht=new e;ht.copy(Rt),y.vmult(ht,ht),m.vadd(ht,ht),O.push(ht)}_>=0&&this.clipFaceAgainstHull(C,g,z,O,G,W,E)};var n=new e,a=new e,c=new e,h=new e,u=new e,d=new e;r.prototype.findSeparatingAxis=function(g,z,w,m,y,C,G,W){var E=n,L=a,_=c,pt=h,st=u,at=d,O=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var ft=0;ft!==Q.uniqueAxes.length;ft++){w.vmult(Q.uniqueAxes[ft],E);var ht=Q.testSepAxis(E,g,z,w,m,y);if(ht===!1)return!1;ht<O&&(O=ht,C.copy(E))}else for(var bt=G?G.length:Q.faces.length,ft=0;ft<bt;ft++){var Rt=G?G[ft]:ft;E.copy(Q.faceNormals[Rt]),w.vmult(E,E);var ht=Q.testSepAxis(E,g,z,w,m,y);if(ht===!1)return!1;ht<O&&(O=ht,C.copy(E))}if(g.uniqueAxes)for(var ft=0;ft!==g.uniqueAxes.length;ft++){y.vmult(g.uniqueAxes[ft],L);var ht=Q.testSepAxis(L,g,z,w,m,y);if(ht===!1)return!1;ht<O&&(O=ht,C.copy(L))}else for(var St=W?W.length:g.faces.length,ft=0;ft<St;ft++){var Rt=W?W[ft]:ft;L.copy(g.faceNormals[Rt]),y.vmult(L,L);var ht=Q.testSepAxis(L,g,z,w,m,y);if(ht===!1)return!1;ht<O&&(O=ht,C.copy(L))}for(var zt=0;zt!==Q.uniqueEdges.length;zt++){w.vmult(Q.uniqueEdges[zt],pt);for(var Mt=0;Mt!==g.uniqueEdges.length;Mt++)if(y.vmult(g.uniqueEdges[Mt],st),pt.cross(st,at),!at.almostZero()){at.normalize();var Vt=Q.testSepAxis(at,g,z,w,m,y);if(Vt===!1)return!1;Vt<O&&(O=Vt,C.copy(at))}}return m.vsub(z,_),_.dot(C)>0&&C.negate(C),!0};var x=[],f=[];r.prototype.testSepAxis=function(g,z,w,m,y,C){var G=this;r.project(G,g,w,m,x),r.project(z,g,y,C,f);var W=x[0],E=x[1],L=f[0],_=f[1],pt=W-_,st=L-E,at=pt<st?pt:st;return at};var b=new e,U=new e;r.prototype.calculateLocalInertia=function(g,z){this.computeLocalAABB(b,U);var w=U.x-b.x,m=U.y-b.y,y=U.z-b.z;z.x=1/12*g*(2*m*2*m+2*y*2*y),z.y=1/12*g*(2*w*2*w+2*y*2*y),z.z=1/12*g*(2*m*2*m+2*w*2*w)},r.prototype.getPlaneConstantOfFace=function(g){var z=this.faces[g],w=this.faceNormals[g],m=this.vertices[z[0]],y=-w.dot(m);return y};var rt=new e,P=new e,k=new e,M=new e,B=new e,T=new e,F=new e,K=new e;r.prototype.clipFaceAgainstHull=function(g,z,w,m,y,C,G){for(var W=rt,E=P,L=k,_=M,pt=B,st=T,at=F,O=K,Q=this,bt=[],ft=m,Rt=bt,ht=-1,St=Number.MAX_VALUE,zt=0;zt<Q.faces.length;zt++){W.copy(Q.faceNormals[zt]),w.vmult(W,W);var Mt=W.dot(g);Mt<St&&(St=Mt,ht=zt)}if(!(ht<0)){var Vt=Q.faces[ht];Vt.connectedFaces=[];for(var At=0;At<Q.faces.length;At++)for(var Ft=0;Ft<Q.faces[At].length;Ft++)Vt.indexOf(Q.faces[At][Ft])!==-1&&At!==ht&&Vt.connectedFaces.indexOf(At)===-1&&Vt.connectedFaces.push(At);ft.length;for(var Et=Vt.length,Wt=0;Wt<Et;Wt++){var Ut=Q.vertices[Vt[Wt]],ne=Q.vertices[Vt[(Wt+1)%Et]];Ut.vsub(ne,E),L.copy(E),w.vmult(L,L),z.vadd(L,L),_.copy(this.faceNormals[ht]),w.vmult(_,_),z.vadd(_,_),L.cross(_,pt),pt.negate(pt),st.copy(Ut),w.vmult(st,st),z.vadd(st,st),-st.dot(pt);var Kt;{var ue=Vt.connectedFaces[Wt];at.copy(this.faceNormals[ue]);var ae=this.getPlaneConstantOfFace(ue);O.copy(at),w.vmult(O,O);var Kt=ae-O.dot(z)}for(this.clipFaceAgainstPlane(ft,Rt,O,Kt);ft.length;)ft.shift();for(;Rt.length;)ft.push(Rt.shift())}at.copy(this.faceNormals[ht]);var ae=this.getPlaneConstantOfFace(ht);O.copy(at),w.vmult(O,O);for(var Kt=ae-O.dot(z),At=0;At<ft.length;At++){var jt=O.dot(ft[At])+Kt;if(jt<=y&&(console.log("clamped: depth="+jt+" to minDist="+(y+"")),jt=y),jt<=C){var ve=ft[At];if(jt<=0){var pe={point:ve,normal:O,depth:jt};G.push(pe)}}}}},r.prototype.clipFaceAgainstPlane=function(g,z,w,m){var y,C,G=g.length;if(G<2)return z;var W=g[g.length-1],E=g[0];y=w.dot(W)+m;for(var L=0;L<G;L++){if(E=g[L],C=w.dot(E)+m,y<0)if(C<0){var _=new e;_.copy(E),z.push(_)}else{var _=new e;W.lerp(E,y/(y-C),_),z.push(_)}else if(C<0){var _=new e;W.lerp(E,y/(y-C),_),z.push(_),z.push(E)}W=E,y=C}return z},r.prototype.computeWorldVertices=function(g,z){for(var w=this.vertices.length;this.worldVertices.length<w;)this.worldVertices.push(new e);for(var m=this.vertices,y=this.worldVertices,C=0;C!==w;C++)z.vmult(m[C],y[C]),g.vadd(y[C],y[C]);this.worldVerticesNeedsUpdate=!1},new e,r.prototype.computeLocalAABB=function(g,z){var w=this.vertices.length,m=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),z.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<w;y++){var C=m[y];C.x<g.x?g.x=C.x:C.x>z.x&&(z.x=C.x),C.y<g.y?g.y=C.y:C.y>z.y&&(z.y=C.y),C.z<g.z?g.z=C.z:C.z>z.z&&(z.z=C.z)}},r.prototype.computeWorldFaceNormals=function(g){for(var z=this.faceNormals.length;this.worldFaceNormals.length<z;)this.worldFaceNormals.push(new e);for(var w=this.faceNormals,m=this.worldFaceNormals,y=0;y!==z;y++)g.vmult(w[y],m[y]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var g=0,z=this.vertices,w=0,m=z.length;w!==m;w++){var y=z[w].norm2();y>g&&(g=y)}this.boundingSphereRadius=Math.sqrt(g)};var Z=new e;r.prototype.calculateWorldAABB=function(g,z,w,m){for(var y=this.vertices.length,C=this.vertices,G,W,E,L,_,pt,st=0;st<y;st++){Z.copy(C[st]),z.vmult(Z,Z),g.vadd(Z,Z);var at=Z;at.x<G||G===void 0?G=at.x:(at.x>L||L===void 0)&&(L=at.x),at.y<W||W===void 0?W=at.y:(at.y>_||_===void 0)&&(_=at.y),at.z<E||E===void 0?E=at.z:(at.z>pt||pt===void 0)&&(pt=at.z)}w.set(G,W,E),m.set(L,_,pt)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(g){g=g||new e;for(var z=this.vertices.length,w=this.vertices,m=0;m<z;m++)g.vadd(w[m],g);return g.mult(1/z,g),g},r.prototype.transformAllPoints=function(g,z){var w=this.vertices.length,m=this.vertices;if(z){for(var y=0;y<w;y++){var C=m[y];z.vmult(C,C)}for(var y=0;y<this.faceNormals.length;y++){var C=this.faceNormals[y];z.vmult(C,C)}}if(g)for(var y=0;y<w;y++){var C=m[y];C.vadd(g,C)}};var ut=new e,R=new e,A=new e;r.prototype.pointIsInside=function(g){var z=this.vertices.length,w=this.vertices,m=this.faces,y=this.faceNormals,C=null,G=this.faces.length,W=ut;this.getAveragePointLocal(W);for(var E=0;E<G;E++){this.faces[E].length;var z=y[E],L=w[m[E][0]],_=R;g.vsub(L,_);var pt=z.dot(_),st=A;W.vsub(L,st);var at=z.dot(st);if(pt<0&&at>0||pt>0&&at<0)return!1}return C?1:-1},new e;var X=new e,q=new e;r.project=function(g,z,w,m,y){var C=g.vertices.length,G=X,W=0,E=0,L=q,_=g.vertices;L.setZero(),s.vectorToLocalFrame(w,m,z,G),s.pointToLocalFrame(w,m,L,L);var pt=L.dot(G);E=W=_[0].dot(G);for(var st=1;st<C;st++){var at=_[st].dot(G);at>W&&(W=at),at<E&&(E=at)}if(E-=pt,W-=pt,E>W){var O=E;E=W,W=O}y[0]=W,y[1]=E}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(v,N,ct){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("./ConvexPolyhedron");function r(l,o,t,i){var n=i,a=[],c=[],h=[],u=[],d=[],x=Math.cos,f=Math.sin;a.push(new e(o*x(0),o*f(0),-t*.5)),u.push(0),a.push(new e(l*x(0),l*f(0),t*.5)),d.push(1);for(var b=0;b<n;b++){var U=2*Math.PI/n*(b+1),rt=2*Math.PI/n*(b+.5);b<n-1?(a.push(new e(o*x(U),o*f(U),-t*.5)),u.push(2*b+2),a.push(new e(l*x(U),l*f(U),t*.5)),d.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(n%2===1||b<n/2)&&c.push(new e(x(rt),f(rt),0))}h.push(d),c.push(new e(0,0,1));for(var P=[],b=0;b<u.length;b++)P.push(u[u.length-b-1]);h.push(P),this.type=p.types.CONVEXPOLYHEDRON,s.call(this,a,h,c)}r.prototype=new s},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(v,N,ct){var p=v("./Shape"),e=v("./ConvexPolyhedron"),s=v("../math/Vec3"),r=v("../utils/Utils");N.exports=l;function l(o,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=o,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,p.call(this),this.pillarConvex=new e,this.pillarOffset=new s,this.type=p.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new p,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var n=0;n!==o[i].length;n++){var a=o[i][n];a<t&&(t=a)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var n=0;n!==o[i].length;n++){var a=o[i][n];a>t&&(t=a)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(o,t,i){var n=this.data;n[o][t]=i,this.clearCachedConvexTrianglePillar(o,t,!1),o>0&&(this.clearCachedConvexTrianglePillar(o-1,t,!0),this.clearCachedConvexTrianglePillar(o-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(o,t-1,!0),this.clearCachedConvexTrianglePillar(o,t-1,!1)),t>0&&o>0&&this.clearCachedConvexTrianglePillar(o-1,t-1,!0)},l.prototype.getRectMinMax=function(o,t,i,n,a){a=a||[];for(var c=this.data,h=this.minValue,u=o;u<=i;u++)for(var d=t;d<=n;d++){var x=c[u][d];x>h&&(h=x)}a[0]=this.minValue,a[1]=h},l.prototype.getIndexOfPosition=function(o,t,i,n){var a=this.elementSize,c=this.data,h=Math.floor(o/a),u=Math.floor(t/a);return i[0]=h,i[1]=u,n&&(h<0&&(h=0),u<0&&(u=0),h>=c.length-1&&(h=c.length-1),u>=c[0].length-1&&(u=c[0].length-1)),!(h<0||u<0||h>=c.length-1||u>=c[0].length-1)},l.prototype.getHeightAt=function(o,t,i){var n=[];this.getIndexOfPosition(o,t,n,i);var a=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,a),(a[0]+a[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(o,t,i){return o+"_"+t+"_"+(i?1:0)},l.prototype.getCachedConvexTrianglePillar=function(o,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.setCachedConvexTrianglePillar=function(o,t,i,n,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]={convex:n,offset:a}},l.prototype.clearCachedConvexTrianglePillar=function(o,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.getConvexTrianglePillar=function(o,t,i){var n=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var c=this.getCachedConvexTrianglePillar(o,t,i);if(c){this.pillarConvex=c.convex,this.pillarOffset=c.offset;return}n=new e,a=new s,this.pillarConvex=n,this.pillarOffset=a}var c=this.data,h=this.elementSize,u=n.faces;n.vertices.length=6;for(var d=0;d<6;d++)n.vertices[d]||(n.vertices[d]=new s);u.length=5;for(var d=0;d<5;d++)u[d]||(u[d]=[]);var x=n.vertices,f=(Math.min(c[o][t],c[o+1][t],c[o][t+1],c[o+1][t+1])-this.minValue)/2+this.minValue;i?(a.set((o+.75)*h,(t+.75)*h,f),x[0].set(.25*h,.25*h,c[o+1][t+1]-f),x[1].set(-.75*h,.25*h,c[o][t+1]-f),x[2].set(.25*h,-.75*h,c[o+1][t]-f),x[3].set(.25*h,.25*h,-f-1),x[4].set(-.75*h,.25*h,-f-1),x[5].set(.25*h,-.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((o+.25)*h,(t+.25)*h,f),x[0].set(-.25*h,-.25*h,c[o][t]-f),x[1].set(.75*h,-.25*h,c[o+1][t]-f),x[2].set(-.25*h,.75*h,c[o][t+1]-f),x[3].set(-.25*h,-.25*h,-f-1),x[4].set(.75*h,-.25*h,-f-1),x[5].set(-.25*h,.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(o,t,i,n,a)},l.prototype.calculateLocalInertia=function(o,t){return t=t||new s,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(o,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var o=this.data,t=this.elementSize;this.boundingSphereRadius=new s(o.length*t,o[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(v,N,ct){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PARTICLE}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){return l=l||new e,l.set(0,0,0),l},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(r,l,o,t){o.copy(r),t.copy(r)}},{"../math/Vec3":30,"./Shape":43}],42:[function(v,N,ct){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new p,s.prototype.constructor=s,s.prototype.computeWorldNormal=function(l){var o=this.worldNormal;o.set(0,0,1),l.vmult(o,o),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(l,o){return o=o||new e,o},s.prototype.volume=function(){return Number.MAX_VALUE};var r=new e;s.prototype.calculateWorldAABB=function(l,o,t,i){r.set(0,0,1),o.vmult(r,r);var n=Number.MAX_VALUE;t.set(-n,-n,-n),i.set(n,n,n),r.x===1&&(i.x=l.x),r.y===1&&(i.y=l.y),r.z===1&&(i.z=l.z),r.x===-1&&(t.x=l.x),r.y===-1&&(t.y=l.y),r.z===-1&&(t.z=l.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(v,N,ct){N.exports=p;var p=v("./Shape");v("../math/Vec3"),v("../math/Quaternion"),v("../material/Material");function p(){this.id=p.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}p.prototype.constructor=p,p.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},p.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},p.prototype.calculateLocalInertia=function(e,s){throw"calculateLocalInertia() not implemented for shape type "+this.type},p.idCounter=0,p.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(v,N,ct){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(r){if(p.call(this),this.radius=r!==void 0?Number(r):1,this.type=p.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){l=l||new e;var o=2*r*this.radius*this.radius/5;return l.x=o,l.y=o,l.z=o,l},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(r,l,o,t){for(var i=this.radius,n=["x","y","z"],a=0;a<n.length;a++){var c=n[a];o[c]=r[c]-i,t[c]=r[c]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(v,N,ct){N.exports=o;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform"),r=v("../collision/AABB"),l=v("../utils/Octree");function o(P,k){p.call(this),this.type=p.types.TRIMESH,this.vertices=new Float32Array(P),this.indices=new Int16Array(k),this.normals=new Float32Array(k.length),this.aabb=new r,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}o.prototype=new p,o.prototype.constructor=o;var t=new e;o.prototype.updateTree=function(){var P=this.tree;P.reset(),P.aabb.copy(this.aabb);var k=this.scale;P.aabb.lowerBound.x*=1/k.x,P.aabb.lowerBound.y*=1/k.y,P.aabb.lowerBound.z*=1/k.z,P.aabb.upperBound.x*=1/k.x,P.aabb.upperBound.y*=1/k.y,P.aabb.upperBound.z*=1/k.z;for(var M=new r,B=new e,T=new e,F=new e,K=[B,T,F],Z=0;Z<this.indices.length/3;Z++){var ut=Z*3;this._getUnscaledVertex(this.indices[ut],B),this._getUnscaledVertex(this.indices[ut+1],T),this._getUnscaledVertex(this.indices[ut+2],F),M.setFromPoints(K),P.insert(M,Z)}P.removeEmptyNodes()};var i=new r;o.prototype.getTrianglesInAABB=function(P,k){i.copy(P);var M=this.scale,B=M.x,T=M.y,F=M.z,K=i.lowerBound,Z=i.upperBound;return K.x/=B,K.y/=T,K.z/=F,Z.x/=B,Z.y/=T,Z.z/=F,this.tree.aabbQuery(i,k)},o.prototype.setScale=function(P){var k=this.scale.x===this.scale.y===this.scale.z,M=P.x===P.y===P.z;k&&M||this.updateNormals(),this.scale.copy(P),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var P=t,k=this.normals,M=0;M<this.indices.length/3;M++){var B=M*3,T=this.indices[B],F=this.indices[B+1],K=this.indices[B+2];this.getVertex(T,u),this.getVertex(F,d),this.getVertex(K,x),o.computeNormal(d,u,x,P),k[B]=P.x,k[B+1]=P.y,k[B+2]=P.z}},o.prototype.updateEdges=function(){for(var P={},k=function(ut,R){var A=T<F?T+"_"+F:F+"_"+T;P[A]=!0},M=0;M<this.indices.length/3;M++){var B=M*3,T=this.indices[B],F=this.indices[B+1];this.indices[B+2],k(),k(),k()}var K=Object.keys(P);this.edges=new Int16Array(K.length*2);for(var M=0;M<K.length;M++){var Z=K[M].split("_");this.edges[2*M]=parseInt(Z[0],10),this.edges[2*M+1]=parseInt(Z[1],10)}},o.prototype.getEdgeVertex=function(P,k,M){var B=this.edges[P*2+(k?1:0)];this.getVertex(B,M)};var n=new e,a=new e;o.prototype.getEdgeVector=function(P,k){var M=n,B=a;this.getEdgeVertex(P,0,M),this.getEdgeVertex(P,1,B),B.vsub(M,k)};var c=new e,h=new e;o.computeNormal=function(P,k,M,B){k.vsub(P,h),M.vsub(k,c),c.cross(h,B),B.isZero()||B.normalize()};var u=new e,d=new e,x=new e;o.prototype.getVertex=function(P,k){var M=this.scale;return this._getUnscaledVertex(P,k),k.x*=M.x,k.y*=M.y,k.z*=M.z,k},o.prototype._getUnscaledVertex=function(P,k){var M=P*3,B=this.vertices;return k.set(B[M],B[M+1],B[M+2])},o.prototype.getWorldVertex=function(P,k,M,B){return this.getVertex(P,B),s.pointToWorldFrame(k,M,B,B),B},o.prototype.getTriangleVertices=function(P,k,M,B){var T=P*3;this.getVertex(this.indices[T],k),this.getVertex(this.indices[T+1],M),this.getVertex(this.indices[T+2],B)},o.prototype.getNormal=function(P,k){var M=P*3;return k.set(this.normals[M],this.normals[M+1],this.normals[M+2])};var f=new r;o.prototype.calculateLocalInertia=function(P,k){this.computeLocalAABB(f);var M=f.upperBound.x-f.lowerBound.x,B=f.upperBound.y-f.lowerBound.y,T=f.upperBound.z-f.lowerBound.z;return k.set(1/12*P*(2*B*2*B+2*T*2*T),1/12*P*(2*M*2*M+2*T*2*T),1/12*P*(2*B*2*B+2*M*2*M))};var b=new e;o.prototype.computeLocalAABB=function(P){var k=P.lowerBound,M=P.upperBound,B=this.vertices.length;this.vertices;var T=b;this.getVertex(0,T),k.copy(T),M.copy(T);for(var F=0;F!==B;F++)this.getVertex(F,T),T.x<k.x?k.x=T.x:T.x>M.x&&(M.x=T.x),T.y<k.y?k.y=T.y:T.y>M.y&&(M.y=T.y),T.z<k.z?k.z=T.z:T.z>M.z&&(M.z=T.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var P=0,k=this.vertices,M=new e,B=0,T=k.length/3;B!==T;B++){this.getVertex(B,M);var F=M.norm2();F>P&&(P=F)}this.boundingSphereRadius=Math.sqrt(P)},new e;var U=new s,rt=new r;o.prototype.calculateWorldAABB=function(P,k,M,B){var T=U,F=rt;T.position=P,T.quaternion=k,this.aabb.toWorldFrame(T,F),M.copy(F.lowerBound),B.copy(F.upperBound)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.createTorus=function(P,k,M,B,T){P=P||1,k=k||.5,M=M||8,B=B||6,T=T||Math.PI*2;for(var F=[],K=[],Z=0;Z<=M;Z++)for(var ut=0;ut<=B;ut++){var R=ut/B*T,A=Z/M*Math.PI*2,X=(P+k*Math.cos(A))*Math.cos(R),q=(P+k*Math.cos(A))*Math.sin(R),g=k*Math.sin(A);F.push(X,q,g)}for(var Z=1;Z<=M;Z++)for(var ut=1;ut<=B;ut++){var z=(B+1)*Z+ut-1,w=(B+1)*(Z-1)+ut-1,m=(B+1)*(Z-1)+ut,y=(B+1)*Z+ut;K.push(z,w,y),K.push(w,m,y)}return new o(F,K)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(v,N,ct){N.exports=e,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver");function e(){p.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new p;var s=[],r=[],l=[];e.prototype.solve=function(o,t){var i=0,n=this.iterations,a=this.tolerance*this.tolerance,c=this.equations,h=c.length,u=t.bodies,d=u.length,x=o,f,b,U,rt,P,k;if(h!==0)for(var M=0;M!==d;M++)u[M].updateSolveMassProperties();var B=r,T=l,F=s;B.length=h,T.length=h,F.length=h;for(var M=0;M!==h;M++){var K=c[M];F[M]=0,T[M]=K.computeB(x),B[M]=1/K.computeC()}if(h!==0){for(var M=0;M!==d;M++){var Z=u[M],ut=Z.vlambda,R=Z.wlambda;ut.set(0,0,0),R&&R.set(0,0,0)}for(i=0;i!==n;i++){rt=0;for(var A=0;A!==h;A++){var K=c[A];f=T[A],b=B[A],k=F[A],P=K.computeGWlambda(),U=b*(f-P-K.eps*k),k+U<K.minForce?U=K.minForce-k:k+U>K.maxForce&&(U=K.maxForce-k),F[A]+=U,rt+=U>0?U:-U,K.addToWlambda(U)}if(rt*rt<a)break}for(var M=0;M!==d;M++){var Z=u[M],X=Z.velocity,q=Z.angularVelocity;X.vadd(Z.vlambda,X),q&&q.vadd(Z.wlambda,q)}}return i}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(v,N,ct){N.exports=p;function p(){this.equations=[]}p.prototype.solve=function(e,s){return 0},p.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},p.prototype.removeEquation=function(e){var s=this.equations,r=s.indexOf(e);r!==-1&&s.splice(r,1)},p.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(v,N,ct){N.exports=s,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver"),e=v("../objects/Body");function s(u){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=u,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new p;var r=[],l=[],o={bodies:[]},t=e.STATIC;function i(u){for(var d=u.length,x=0;x!==d;x++){var f=u[x];if(!f.visited&&!(f.body.type&t))return f}return!1}var n=[];function a(u,d,x,f){for(n.push(u),u.visited=!0,d(u,x,f);n.length;)for(var b=n.pop(),U;U=i(b.children);)U.visited=!0,d(U,x,f),n.push(U)}function c(u,d,x){d.push(u.body);for(var f=u.eqs.length,b=0;b!==f;b++){var U=u.eqs[b];x.indexOf(U)===-1&&x.push(U)}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(u,d){for(var x=r,f=this.nodePool,b=d.bodies,U=this.equations,rt=U.length,P=b.length,k=this.subsolver;f.length<P;)f.push(this.createNode());x.length=P;for(var M=0;M<P;M++)x[M]=f[M];for(var M=0;M!==P;M++){var B=x[M];B.body=b[M],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var T=0;T!==rt;T++){var F=U[T],M=b.indexOf(F.bi),K=b.indexOf(F.bj),Z=x[M],ut=x[K];Z.children.push(ut),Z.eqs.push(F),ut.children.push(Z),ut.eqs.push(F)}var R,A=0,X=l;k.tolerance=this.tolerance,k.iterations=this.iterations;for(var q=o;R=i(x);){X.length=0,q.bodies.length=0,a(R,c,q.bodies,X);var g=X.length;X=X.sort(h);for(var M=0;M!==g;M++)k.addEquation(X[M]);k.solve(u,q),k.removeAllEquations(),A++}return A};function h(u,d){return d.id-u.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(v,N,ct){var p=function(){};N.exports=p,p.prototype={constructor:p,addEventListener:function(e,s){this._listeners===void 0&&(this._listeners={});var r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(s)===-1&&r[e].push(s),this},hasEventListener:function(e,s){if(this._listeners===void 0)return!1;var r=this._listeners;return r[e]!==void 0&&r[e].indexOf(s)!==-1},removeEventListener:function(e,s){if(this._listeners===void 0)return this;var r=this._listeners;if(r[e]===void 0)return this;var l=r[e].indexOf(s);return l!==-1&&r[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var s=this._listeners,r=s[e.type];if(r!==void 0){e.target=this;for(var l=0,o=r.length;l<o;l++)r[l].call(this,e)}return this}}},{}],50:[function(v,N,ct){var p=v("../collision/AABB"),e=v("../math/Vec3");N.exports=r;function s(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new p,this.data=[],this.children=[]}function r(t,i){i=i||{},i.root=null,i.aabb=t,s.call(this,i),this.maxDepth=typeof i.maxDepth<"u"?i.maxDepth:8}r.prototype=new s,s.prototype.reset=function(t,i){this.children.length=this.data.length=0},s.prototype.insert=function(t,i,n){var a=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var c=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var h=!1;c.length||(this.subdivide(),h=!0);for(var u=0;u!==8;u++)if(c[u].insert(t,i,n+1))return!0;h&&(c.length=0)}return a.push(i),!0};var l=new e;s.prototype.subdivide=function(){var t=this.aabb,i=t.lowerBound,n=t.upperBound,a=this.children;a.push(new s({aabb:new p({lowerBound:new e(0,0,0)})}),new s({aabb:new p({lowerBound:new e(1,0,0)})}),new s({aabb:new p({lowerBound:new e(1,1,0)})}),new s({aabb:new p({lowerBound:new e(1,1,1)})}),new s({aabb:new p({lowerBound:new e(0,1,1)})}),new s({aabb:new p({lowerBound:new e(0,0,1)})}),new s({aabb:new p({lowerBound:new e(1,0,1)})}),new s({aabb:new p({lowerBound:new e(0,1,0)})})),n.vsub(i,l),l.scale(.5,l);for(var c=this.root||this,h=0;h!==8;h++){var u=a[h];u.root=c;var d=u.aabb.lowerBound;d.x*=l.x,d.y*=l.y,d.z*=l.z,d.vadd(i,d),d.vadd(l,u.aabb.upperBound)}},s.prototype.aabbQuery=function(t,i){this.data,this.children;for(var n=[this];n.length;){var a=n.pop();a.aabb.overlaps(t)&&Array.prototype.push.apply(i,a.data),Array.prototype.push.apply(n,a.children)}return i};var o=new p;s.prototype.rayQuery=function(t,i,n){return t.getAABB(o),o.toLocalFrame(i,o),this.aabbQuery(o,n),n},s.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var i=t.pop(),n=i.children.length-1;n>=0;n--)i.children[n].data.length||i.children.splice(n,1);Array.prototype.push.apply(t,i.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(v,N,ct){N.exports=p;function p(){this.objects=[],this.type=Object}p.prototype.release=function(){for(var e=arguments.length,s=0;s!==e;s++)this.objects.push(arguments[s])},p.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},p.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(v,N,ct){N.exports=p;function p(){this.data={keys:[]}}p.prototype.get=function(e,s){if(e>s){var r=s;s=e,e=r}return this.data[e+"-"+s]},p.prototype.set=function(e,s,r){if(e>s){var l=s;s=e,e=l}var o=e+"-"+s;this.get(e,s)||this.data.keys.push(o),this.data[o]=r},p.prototype.reset=function(){for(var e=this.data,s=e.keys;s.length>0;){var r=s.pop();delete e[r]}}},{}],53:[function(v,N,ct){function p(){}N.exports=p,p.defaults=function(e,s){e=e||{};for(var r in s)r in e||(e[r]=s[r]);return e}},{}],54:[function(v,N,ct){N.exports=s;var p=v("../math/Vec3"),e=v("./Pool");function s(){e.call(this),this.type=p}s.prototype=new e,s.prototype.constructObject=function(){return new p}},{"../math/Vec3":30,"./Pool":51}],55:[function(v,N,ct){N.exports=a;var p=v("../collision/AABB"),e=v("../shapes/Shape"),s=v("../collision/Ray"),r=v("../math/Vec3"),l=v("../math/Transform");v("../shapes/ConvexPolyhedron");var o=v("../math/Quaternion");v("../solver/Solver");var t=v("../utils/Vec3Pool"),i=v("../equations/ContactEquation"),n=v("../equations/FrictionEquation");function a(V){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=V,this.currentContactMaterial=null,this.enableFrictionReduction=!1}a.prototype.createContactEquation=function(V,I,H,D,yt,nt){var J;this.contactPointPool.length?(J=this.contactPointPool.pop(),J.bi=V,J.bj=I):J=new i(V,I),J.enabled=V.collisionResponse&&I.collisionResponse&&H.collisionResponse&&D.collisionResponse;var ot=this.currentContactMaterial;J.restitution=ot.restitution,J.setSpookParams(ot.contactEquationStiffness,ot.contactEquationRelaxation,this.world.dt);var S=H.material||V.material,$=D.material||I.material;return S&&$&&S.restitution>=0&&$.restitution>=0&&(J.restitution=S.restitution*$.restitution),J.si=yt||H,J.sj=nt||D,J},a.prototype.createFrictionEquationsFromContact=function(V,I){var H=V.bi,D=V.bj,yt=V.si,nt=V.sj,J=this.world,ot=this.currentContactMaterial,S=ot.friction,$=yt.material||H.material,it=nt.material||D.material;if($&&it&&$.friction>=0&&it.friction>=0&&(S=$.friction*it.friction),S>0){var lt=S*J.gravity.length(),tt=H.invMass+D.invMass;tt>0&&(tt=1/tt);var j=this.frictionEquationPool,et=j.length?j.pop():new n(H,D,lt*tt),vt=j.length?j.pop():new n(H,D,lt*tt);return et.bi=vt.bi=H,et.bj=vt.bj=D,et.minForce=vt.minForce=-lt*tt,et.maxForce=vt.maxForce=lt*tt,et.ri.copy(V.ri),et.rj.copy(V.rj),vt.ri.copy(V.ri),vt.rj.copy(V.rj),V.ni.tangents(et.t,vt.t),et.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),vt.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),et.enabled=vt.enabled=V.enabled,I.push(et,vt),!0}return!1};var c=new r,h=new r,u=new r;a.prototype.createFrictionFromAverage=function(V){var I=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(I,this.frictionResult)||V===1)){var H=this.frictionResult[this.frictionResult.length-2],D=this.frictionResult[this.frictionResult.length-1];c.setZero(),h.setZero(),u.setZero();var yt=I.bi;I.bj;for(var nt=0;nt!==V;nt++)I=this.result[this.result.length-1-nt],I.bodyA!==yt?(c.vadd(I.ni,c),h.vadd(I.ri,h),u.vadd(I.rj,u)):(c.vsub(I.ni,c),h.vadd(I.rj,h),u.vadd(I.ri,u));var J=1/V;h.scale(J,H.ri),u.scale(J,H.rj),D.ri.copy(H.ri),D.rj.copy(H.rj),c.normalize(),c.tangents(H.t,D.t)}};var d=new r,x=new r,f=new o,b=new o;a.prototype.getContacts=function(V,I,H,D,yt,nt,J){this.contactPointPool=yt,this.frictionEquationPool=J,this.result=D,this.frictionResult=nt;for(var ot=f,S=b,$=d,it=x,lt=0,tt=V.length;lt!==tt;lt++){var j=V[lt],et=I[lt],vt=null;j.material&&et.material&&(vt=H.getContactMaterial(j.material,et.material)||null);for(var wt=0;wt<j.shapes.length;wt++){j.quaternion.mult(j.shapeOrientations[wt],ot),j.quaternion.vmult(j.shapeOffsets[wt],$),$.vadd(j.position,$);for(var Y=j.shapes[wt],xt=0;xt<et.shapes.length;xt++){et.quaternion.mult(et.shapeOrientations[xt],S),et.quaternion.vmult(et.shapeOffsets[xt],it),it.vadd(et.position,it);var gt=et.shapes[xt];if(!($.distanceTo(it)>Y.boundingSphereRadius+gt.boundingSphereRadius)){var It=null;Y.material&&gt.material&&(It=H.getContactMaterial(Y.material,gt.material)||null),this.currentContactMaterial=It||vt||H.defaultContactMaterial;var Bt=this[Y.type|gt.type];Bt&&(Y.type<gt.type?Bt.call(this,Y,gt,$,it,ot,S,j,et,Y,gt):Bt.call(this,gt,Y,it,$,S,ot,et,j,Y,gt))}}}}},a.prototype[e.types.BOX|e.types.BOX]=a.prototype.boxBox=function(V,I,H,D,yt,nt,J,ot){V.convexPolyhedronRepresentation.material=V.material,I.convexPolyhedronRepresentation.material=I.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.convexConvex(V.convexPolyhedronRepresentation,I.convexPolyhedronRepresentation,H,D,yt,nt,J,ot,V,I)},a.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=a.prototype.boxConvex=function(V,I,H,D,yt,nt,J,ot){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexConvex(V.convexPolyhedronRepresentation,I,H,D,yt,nt,J,ot,V,I)},a.prototype[e.types.BOX|e.types.PARTICLE]=a.prototype.boxParticle=function(V,I,H,D,yt,nt,J,ot){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexParticle(V.convexPolyhedronRepresentation,I,H,D,yt,nt,J,ot,V,I)},a.prototype[e.types.SPHERE]=a.prototype.sphereSphere=function(V,I,H,D,yt,nt,J,ot){var S=this.createContactEquation(J,ot,V,I);D.vsub(H,S.ni),S.ni.normalize(),S.ri.copy(S.ni),S.rj.copy(S.ni),S.ri.mult(V.radius,S.ri),S.rj.mult(-I.radius,S.rj),S.ri.vadd(H,S.ri),S.ri.vsub(J.position,S.ri),S.rj.vadd(D,S.rj),S.rj.vsub(ot.position,S.rj),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)};var U=new r,rt=new r,P=new r;a.prototype[e.types.PLANE|e.types.TRIMESH]=a.prototype.planeTrimesh=function(V,I,H,D,yt,nt,J,ot){var S=new r,$=U;$.set(0,0,1),yt.vmult($,$);for(var it=0;it<I.vertices.length/3;it++){I.getVertex(it,S);var lt=new r;lt.copy(S),l.pointToWorldFrame(D,nt,lt,S);var tt=rt;S.vsub(H,tt);var j=$.dot(tt);if(j<=0){var et=this.createContactEquation(J,ot,V,I);et.ni.copy($);var vt=P;$.scale(tt.dot($),vt),S.vsub(vt,vt),et.ri.copy(vt),et.ri.vsub(J.position,et.ri),et.rj.copy(S),et.rj.vsub(ot.position,et.rj),this.result.push(et),this.createFrictionEquationsFromContact(et,this.frictionResult)}}};var k=new r,M=new r;new r;var B=new r,T=new r,F=new r,K=new r,Z=new r,ut=new r,R=new r,A=new r,X=new r,q=new r,g=new r,z=new p,w=[];a.prototype[e.types.SPHERE|e.types.TRIMESH]=a.prototype.sphereTrimesh=function(V,I,H,D,yt,nt,J,ot){var S=F,$=K,it=Z,lt=ut,tt=R,j=A,et=z,vt=T,wt=M,Y=w;l.pointToLocalFrame(D,nt,H,tt);var xt=V.radius;et.lowerBound.set(tt.x-xt,tt.y-xt,tt.z-xt),et.upperBound.set(tt.x+xt,tt.y+xt,tt.z+xt),I.getTrianglesInAABB(et,Y);for(var gt=B,It=V.radius*V.radius,Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++)if(I.getVertex(I.indices[Y[Bt]*3+Ct],gt),gt.vsub(tt,wt),wt.norm2()<=It){vt.copy(gt),l.pointToWorldFrame(D,nt,vt,gt),gt.vsub(H,wt);var dt=this.createContactEquation(J,ot,V,I);dt.ni.copy(wt),dt.ni.normalize(),dt.ri.copy(dt.ni),dt.ri.scale(V.radius,dt.ri),dt.ri.vadd(H,dt.ri),dt.ri.vsub(J.position,dt.ri),dt.rj.copy(gt),dt.rj.vsub(ot.position,dt.rj),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}for(var Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++){I.getVertex(I.indices[Y[Bt]*3+Ct],S),I.getVertex(I.indices[Y[Bt]*3+(Ct+1)%3],$),$.vsub(S,it),tt.vsub($,j);var Jt=j.dot(it);tt.vsub(S,j);var $t=j.dot(it);if($t>0&&Jt<0){tt.vsub(S,j),lt.copy(it),lt.normalize(),$t=j.dot(lt),lt.scale($t,j),j.vadd(S,j);var Ht=j.distanceTo(tt);if(Ht<V.radius){var dt=this.createContactEquation(J,ot,V,I);j.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(V.radius,dt.ri),l.pointToWorldFrame(D,nt,j,j),j.vsub(ot.position,dt.rj),l.vectorToWorldFrame(nt,dt.ni,dt.ni),l.vectorToWorldFrame(nt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}}for(var se=X,Dt=q,Pt=g,le=k,Bt=0,Tt=Y.length;Bt!==Tt;Bt++){I.getTriangleVertices(Y[Bt],se,Dt,Pt),I.getNormal(Y[Bt],le),tt.vsub(se,j);var Ht=j.dot(le);if(le.scale(Ht,j),tt.vsub(j,j),Ht=j.distanceTo(tt),s.pointInTriangle(j,se,Dt,Pt)&&Ht<V.radius){var dt=this.createContactEquation(J,ot,V,I);j.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(V.radius,dt.ri),l.pointToWorldFrame(D,nt,j,j),j.vsub(ot.position,dt.rj),l.vectorToWorldFrame(nt,dt.ni,dt.ni),l.vectorToWorldFrame(nt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}Y.length=0};var m=new r,y=new r;a.prototype[e.types.SPHERE|e.types.PLANE]=a.prototype.spherePlane=function(V,I,H,D,yt,nt,J,ot){var S=this.createContactEquation(J,ot,V,I);if(S.ni.set(0,0,1),nt.vmult(S.ni,S.ni),S.ni.negate(S.ni),S.ni.normalize(),S.ni.mult(V.radius,S.ri),H.vsub(D,m),S.ni.mult(S.ni.dot(m),y),m.vsub(y,S.rj),-m.dot(S.ni)<=V.radius){var $=S.ri,it=S.rj;$.vadd(H,$),$.vsub(J.position,$),it.vadd(D,it),it.vsub(ot.position,it),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}};var C=new r,G=new r,W=new r;function E(V,I,H){for(var D=null,yt=V.length,nt=0;nt!==yt;nt++){var J=V[nt],ot=C;V[(nt+1)%yt].vsub(J,ot);var S=G;ot.cross(I,S);var $=W;H.vsub(J,$);var it=S.dot($);if(D===null||it>0&&D===!0||it<=0&&D===!1){D===null&&(D=it>0);continue}else return!1}return!0}var L=new r,_=new r,pt=new r,st=new r,at=[new r,new r,new r,new r,new r,new r],O=new r,Q=new r,bt=new r,ft=new r;a.prototype[e.types.SPHERE|e.types.BOX]=a.prototype.sphereBox=function(V,I,H,D,yt,nt,J,ot){var S=this.v3pool,$=at;H.vsub(D,L),I.getSideNormals($,nt);for(var it=V.radius,lt=!1,tt=Q,j=bt,et=ft,vt=null,wt=0,Y=0,xt=0,gt=null,It=0,Bt=$.length;It!==Bt&&lt===!1;It++){var Ct=_;Ct.copy($[It]);var dt=Ct.norm();Ct.normalize();var Jt=L.dot(Ct);if(Jt<dt+it&&Jt>0){var $t=pt,Ht=st;$t.copy($[(It+1)%3]),Ht.copy($[(It+2)%3]);var se=$t.norm(),Dt=Ht.norm();$t.normalize(),Ht.normalize();var Pt=L.dot($t),le=L.dot(Ht);if(Pt<se&&Pt>-se&&le<Dt&&le>-Dt){var qt=Math.abs(Jt-dt-it);(gt===null||qt<gt)&&(gt=qt,Y=Pt,xt=le,vt=dt,tt.copy(Ct),j.copy($t),et.copy(Ht),wt++)}}}if(wt){lt=!0;var mt=this.createContactEquation(J,ot,V,I);tt.mult(-it,mt.ri),mt.ni.copy(tt),mt.ni.negate(mt.ni),tt.mult(vt,tt),j.mult(Y,j),tt.vadd(j,tt),et.mult(xt,et),tt.vadd(et,mt.rj),mt.ri.vadd(H,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}for(var Tt=S.get(),he=O,Xt=0;Xt!==2&&!lt;Xt++)for(var kt=0;kt!==2&&!lt;kt++)for(var Ot=0;Ot!==2&&!lt;Ot++)if(Tt.set(0,0,0),Xt?Tt.vadd($[0],Tt):Tt.vsub($[0],Tt),kt?Tt.vadd($[1],Tt):Tt.vsub($[1],Tt),Ot?Tt.vadd($[2],Tt):Tt.vsub($[2],Tt),D.vadd(Tt,he),he.vsub(H,he),he.norm2()<it*it){lt=!0;var mt=this.createContactEquation(J,ot,V,I);mt.ri.copy(he),mt.ri.normalize(),mt.ni.copy(mt.ri),mt.ri.mult(it,mt.ri),mt.rj.copy(Tt),mt.ri.vadd(H,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}S.release(Tt),Tt=null;for(var te=S.get(),ce=S.get(),mt=S.get(),Qt=S.get(),qt=S.get(),me=$.length,Xt=0;Xt!==me&&!lt;Xt++)for(var kt=0;kt!==me&&!lt;kt++)if(Xt%3!==kt%3){$[kt].cross($[Xt],te),te.normalize(),$[Xt].vadd($[kt],ce),mt.copy(H),mt.vsub(ce,mt),mt.vsub(D,mt);var we=mt.dot(te);te.mult(we,Qt);for(var Ot=0;Ot===Xt%3||Ot===kt%3;)Ot++;qt.copy(H),qt.vsub(Qt,qt),qt.vsub(ce,qt),qt.vsub(D,qt);var Se=Math.abs(we),Me=qt.norm();if(Se<$[Ot].norm()&&Me<it){lt=!0;var Nt=this.createContactEquation(J,ot,V,I);ce.vadd(Qt,Nt.rj),Nt.rj.copy(Nt.rj),qt.negate(Nt.ni),Nt.ni.normalize(),Nt.ri.copy(Nt.rj),Nt.ri.vadd(D,Nt.ri),Nt.ri.vsub(H,Nt.ri),Nt.ri.normalize(),Nt.ri.mult(it,Nt.ri),Nt.ri.vadd(H,Nt.ri),Nt.ri.vsub(J.position,Nt.ri),Nt.rj.vadd(D,Nt.rj),Nt.rj.vsub(ot.position,Nt.rj),this.result.push(Nt),this.createFrictionEquationsFromContact(Nt,this.frictionResult)}}S.release(te,ce,mt,Qt,qt)};var Rt=new r,ht=new r,St=new r,zt=new r,Mt=new r,Vt=new r,At=new r,Ft=new r,Et=new r,Wt=new r;a.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=a.prototype.sphereConvex=function(V,I,H,D,yt,nt,J,ot){var S=this.v3pool;H.vsub(D,Rt);for(var $=I.faceNormals,it=I.faces,lt=I.vertices,tt=V.radius,j=0;j!==lt.length;j++){var et=lt[j],vt=Mt;nt.vmult(et,vt),D.vadd(vt,vt);var wt=zt;if(vt.vsub(H,wt),wt.norm2()<tt*tt){xt=!0;var Y=this.createContactEquation(J,ot,V,I);Y.ri.copy(wt),Y.ri.normalize(),Y.ni.copy(Y.ri),Y.ri.mult(tt,Y.ri),vt.vsub(D,Y.rj),Y.ri.vadd(H,Y.ri),Y.ri.vsub(J.position,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);return}}for(var xt=!1,j=0,gt=it.length;j!==gt&&xt===!1;j++){var It=$[j],Bt=it[j],Ct=Vt;nt.vmult(It,Ct);var dt=At;nt.vmult(lt[Bt[0]],dt),dt.vadd(D,dt);var Jt=Ft;Ct.mult(-tt,Jt),H.vadd(Jt,Jt);var $t=Et;Jt.vsub(dt,$t);var Ht=$t.dot(Ct),se=Wt;if(H.vsub(dt,se),Ht<0&&se.dot(Ct)>0){for(var Dt=[],Pt=0,le=Bt.length;Pt!==le;Pt++){var Tt=S.get();nt.vmult(lt[Bt[Pt]],Tt),D.vadd(Tt,Tt),Dt.push(Tt)}if(E(Dt,Ct,H)){xt=!0;var Y=this.createContactEquation(J,ot,V,I);Ct.mult(-tt,Y.ri),Ct.negate(Y.ni);var he=S.get();Ct.mult(-Ht,he);var Xt=S.get();Ct.mult(-tt,Xt),H.vsub(D,Y.rj),Y.rj.vadd(Xt,Y.rj),Y.rj.vadd(he,Y.rj),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),Y.ri.vadd(H,Y.ri),Y.ri.vsub(J.position,Y.ri),S.release(he),S.release(Xt),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt]);return}else for(var Pt=0;Pt!==Bt.length;Pt++){var Ot=S.get(),te=S.get();nt.vmult(lt[Bt[(Pt+1)%Bt.length]],Ot),nt.vmult(lt[Bt[(Pt+2)%Bt.length]],te),D.vadd(Ot,Ot),D.vadd(te,te);var ce=ht;te.vsub(Ot,ce);var mt=St;ce.unit(mt);var Qt=S.get(),qt=S.get();H.vsub(Ot,qt);var me=qt.dot(mt);mt.mult(me,Qt),Qt.vadd(Ot,Qt);var we=S.get();if(Qt.vsub(H,we),me>0&&me*me<ce.norm2()&&we.norm2()<tt*tt){var Y=this.createContactEquation(J,ot,V,I);Qt.vsub(D,Y.rj),Qt.vsub(H,Y.ni),Y.ni.normalize(),Y.ni.mult(tt,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),Y.ri.vadd(H,Y.ri),Y.ri.vsub(J.position,Y.ri),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt]);S.release(Ot),S.release(te),S.release(Qt),S.release(we),S.release(qt);return}S.release(Ot),S.release(te),S.release(Qt),S.release(we),S.release(qt)}for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt])}}},new r,new r,a.prototype[e.types.PLANE|e.types.BOX]=a.prototype.planeBox=function(V,I,H,D,yt,nt,J,ot){I.convexPolyhedronRepresentation.material=I.material,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.planeConvex(V,I.convexPolyhedronRepresentation,H,D,yt,nt,J,ot)};var Ut=new r,ne=new r,ue=new r,ae=new r;a.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=a.prototype.planeConvex=function(V,I,H,D,yt,nt,J,ot){var S=Ut,$=ne;$.set(0,0,1),yt.vmult($,$);for(var it=0,lt=ue,tt=0;tt!==I.vertices.length;tt++){S.copy(I.vertices[tt]),nt.vmult(S,S),D.vadd(S,S),S.vsub(H,lt);var j=$.dot(lt);if(j<=0){var et=this.createContactEquation(J,ot,V,I),vt=ae;$.mult($.dot(lt),vt),S.vsub(vt,vt),vt.vsub(H,et.ri),et.ni.copy($),S.vsub(D,et.rj),et.ri.vadd(H,et.ri),et.ri.vsub(J.position,et.ri),et.rj.vadd(D,et.rj),et.rj.vsub(ot.position,et.rj),this.result.push(et),it++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(et,this.frictionResult)}}this.enableFrictionReduction&&it&&this.createFrictionFromAverage(it)};var Kt=new r,jt=new r;a.prototype[e.types.CONVEXPOLYHEDRON]=a.prototype.convexConvex=function(V,I,H,D,yt,nt,J,ot,S,$,it,lt){var tt=Kt;if(!(H.distanceTo(D)>V.boundingSphereRadius+I.boundingSphereRadius)&&V.findSeparatingAxis(I,H,yt,D,nt,tt,it,lt)){var j=[],et=jt;V.clipAgainstHull(H,yt,I,D,nt,tt,-100,100,j);for(var vt=0,wt=0;wt!==j.length;wt++){var Y=this.createContactEquation(J,ot,V,I,S,$),xt=Y.ri,gt=Y.rj;tt.negate(Y.ni),j[wt].normal.negate(et),et.mult(j[wt].depth,et),j[wt].point.vadd(et,xt),gt.copy(j[wt].point),xt.vsub(H,xt),gt.vsub(D,gt),xt.vadd(H,xt),xt.vsub(J.position,xt),gt.vadd(D,gt),gt.vsub(ot.position,gt),this.result.push(Y),vt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(Y,this.frictionResult)}this.enableFrictionReduction&&vt&&this.createFrictionFromAverage(vt)}};var ve=new r,pe=new r,ie=new r;a.prototype[e.types.PLANE|e.types.PARTICLE]=a.prototype.planeParticle=function(V,I,H,D,yt,nt,J,ot){var S=ve;S.set(0,0,1),J.quaternion.vmult(S,S);var $=pe;D.vsub(J.position,$);var it=S.dot($);if(it<=0){var lt=this.createContactEquation(ot,J,I,V);lt.ni.copy(S),lt.ni.negate(lt.ni),lt.ri.set(0,0,0);var tt=ie;S.mult(S.dot(D),tt),D.vsub(tt,tt),lt.rj.copy(tt),this.result.push(lt),this.createFrictionEquationsFromContact(lt,this.frictionResult)}};var ee=new r;a.prototype[e.types.PARTICLE|e.types.SPHERE]=a.prototype.sphereParticle=function(V,I,H,D,yt,nt,J,ot){var S=ee;S.set(0,0,1),D.vsub(H,S);var $=S.norm2();if($<=V.radius*V.radius){var it=this.createContactEquation(ot,J,I,V);S.normalize(),it.rj.copy(S),it.rj.mult(V.radius,it.rj),it.ni.copy(S),it.ni.negate(it.ni),it.ri.set(0,0,0),this.result.push(it),this.createFrictionEquationsFromContact(it,this.frictionResult)}};var Yt=new o,re=new r;new r;var oe=new r,Gt=new r,de=new r;a.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=a.prototype.convexParticle=function(V,I,H,D,yt,nt,J,ot){var S=-1,$=oe,it=de,lt=null,tt=re;if(tt.copy(D),tt.vsub(H,tt),yt.conjugate(Yt),Yt.vmult(tt,tt),V.pointIsInside(tt)){V.worldVerticesNeedsUpdate&&V.computeWorldVertices(H,yt),V.worldFaceNormalsNeedsUpdate&&V.computeWorldFaceNormals(yt);for(var j=0,et=V.faces.length;j!==et;j++){var vt=[V.worldVertices[V.faces[j][0]]],wt=V.worldFaceNormals[j];D.vsub(vt[0],Gt);var Y=-wt.dot(Gt);(lt===null||Math.abs(Y)<Math.abs(lt))&&(lt=Y,S=j,$.copy(wt))}if(S!==-1){var xt=this.createContactEquation(ot,J,I,V);$.mult(lt,it),it.vadd(D,it),it.vsub(H,it),xt.rj.copy(it),$.negate(xt.ni),xt.ri.set(0,0,0);var gt=xt.ri,It=xt.rj;gt.vadd(D,gt),gt.vsub(ot.position,gt),It.vadd(H,It),It.vsub(J.position,It),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},a.prototype[e.types.BOX|e.types.HEIGHTFIELD]=a.prototype.boxHeightfield=function(V,I,H,D,yt,nt,J,ot){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexHeightfield(V.convexPolyhedronRepresentation,I,H,D,yt,nt,J,ot)};var fe=new r,ye=new r,xe=[0];a.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=a.prototype.convexHeightfield=function(V,I,H,D,yt,nt,J,ot){var S=I.data,$=I.elementSize,it=V.boundingSphereRadius,lt=ye,tt=xe,j=fe;l.pointToLocalFrame(D,nt,H,j);var et=Math.floor((j.x-it)/$)-1,vt=Math.ceil((j.x+it)/$)+1,wt=Math.floor((j.y-it)/$)-1,Y=Math.ceil((j.y+it)/$)+1;if(!(vt<0||Y<0||et>S.length||wt>S[0].length)){et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),Y<0&&(Y=0),et>=S.length&&(et=S.length-1),vt>=S.length&&(vt=S.length-1),Y>=S[0].length&&(Y=S[0].length-1),wt>=S[0].length&&(wt=S[0].length-1);var xt=[];I.getRectMinMax(et,wt,vt,Y,xt);var gt=xt[0],It=xt[1];if(!(j.z-it>It||j.z+it<gt))for(var Bt=et;Bt<vt;Bt++)for(var Ct=wt;Ct<Y;Ct++)I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,nt,I.pillarOffset,lt),H.distanceTo(lt)<I.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.convexConvex(V,I.pillarConvex,H,lt,yt,nt,J,ot,null,null,tt,null),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,nt,I.pillarOffset,lt),H.distanceTo(lt)<I.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.convexConvex(V,I.pillarConvex,H,lt,yt,nt,J,ot,null,null,tt,null)}};var ge=new r,Lt=new r;a.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=a.prototype.sphereHeightfield=function(V,I,H,D,yt,nt,J,ot){var S=I.data,$=V.radius,it=I.elementSize,lt=Lt,tt=ge;l.pointToLocalFrame(D,nt,H,tt);var j=Math.floor((tt.x-$)/it)-1,et=Math.ceil((tt.x+$)/it)+1,vt=Math.floor((tt.y-$)/it)-1,wt=Math.ceil((tt.y+$)/it)+1;if(!(et<0||wt<0||j>S.length||wt>S[0].length)){j<0&&(j=0),et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),j>=S.length&&(j=S.length-1),et>=S.length&&(et=S.length-1),wt>=S[0].length&&(wt=S[0].length-1),vt>=S[0].length&&(vt=S[0].length-1);var Y=[];I.getRectMinMax(j,vt,et,wt,Y);var xt=Y[0],gt=Y[1];if(!(tt.z-$>gt||tt.z+$<xt))for(var It=this.result,Bt=j;Bt<et;Bt++)for(var Ct=vt;Ct<wt;Ct++){var dt=It.length;I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,nt,I.pillarOffset,lt),H.distanceTo(lt)<I.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.sphereConvex(V,I.pillarConvex,H,lt,yt,nt,J,ot),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,nt,I.pillarOffset,lt),H.distanceTo(lt)<I.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.sphereConvex(V,I.pillarConvex,H,lt,yt,nt,J,ot);var Jt=It.length-dt;if(Jt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(v,N,ct){N.exports=f;var p=v("../shapes/Shape"),e=v("../math/Vec3"),s=v("../math/Quaternion"),r=v("../solver/GSSolver");v("../utils/Vec3Pool"),v("../equations/ContactEquation"),v("../equations/FrictionEquation");var l=v("./Narrowphase"),o=v("../utils/EventTarget"),t=v("../collision/ArrayCollisionMatrix"),i=v("../material/Material"),n=v("../material/ContactMaterial"),a=v("../objects/Body"),c=v("../utils/TupleDictionary"),h=v("../collision/RaycastResult"),u=v("../collision/AABB"),d=v("../collision/Ray"),x=v("../collision/NaiveBroadphase");function f(){o.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new x,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new i("default"),this.defaultContactMaterial=new n(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}f.prototype=new o,new u;var b=new d;if(f.prototype.getContactMaterial=function(A,X){return this.contactMaterialTable.get(A.id,X.id)},f.prototype.numObjects=function(){return this.bodies.length},f.prototype.collisionMatrixTick=function(){var A=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=A,this.collisionMatrix.reset()},f.prototype.add=f.prototype.addBody=function(A){this.bodies.indexOf(A)===-1&&(A.index=this.bodies.length,this.bodies.push(A),A.world=this,A.initPosition.copy(A.position),A.initVelocity.copy(A.velocity),A.timeLastSleepy=this.time,A instanceof a&&(A.initAngularVelocity.copy(A.angularVelocity),A.initQuaternion.copy(A.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=A,this.dispatchEvent(this.addBodyEvent))},f.prototype.addConstraint=function(A){this.constraints.push(A)},f.prototype.removeConstraint=function(A){var X=this.constraints.indexOf(A);X!==-1&&this.constraints.splice(X,1)},f.prototype.rayTest=function(A,X,q){q instanceof h?this.raycastClosest(A,X,{skipBackfaces:!0},q):this.raycastAll(A,X,{skipBackfaces:!0},q)},f.prototype.raycastAll=function(A,X,q,g){return q.mode=d.ALL,q.from=A,q.to=X,q.callback=g,b.intersectWorld(this,q)},f.prototype.raycastAny=function(A,X,q,g){return q.mode=d.ANY,q.from=A,q.to=X,q.result=g,b.intersectWorld(this,q)},f.prototype.raycastClosest=function(A,X,q,g){return q.mode=d.CLOSEST,q.from=A,q.to=X,q.result=g,b.intersectWorld(this,q)},f.prototype.remove=function(A){A.world=null;var X=this.bodies.length-1,q=this.bodies,g=q.indexOf(A);if(g!==-1){q.splice(g,1);for(var z=0;z!==q.length;z++)q[z].index=z;this.collisionMatrix.setNumObjects(X),this.removeBodyEvent.body=A,this.dispatchEvent(this.removeBodyEvent)}},f.prototype.removeBody=f.prototype.remove,f.prototype.addMaterial=function(A){this.materials.push(A)},f.prototype.addContactMaterial=function(A){this.contactmaterials.push(A),this.contactMaterialTable.set(A.materials[0].id,A.materials[1].id,A)},typeof performance>"u"&&(performance={}),!performance.now){var U=Date.now();performance.timing&&performance.timing.navigationStart&&(U=performance.timing.navigationStart),performance.now=function(){return Date.now()-U}}var rt=new e;f.prototype.step=function(A,X,q){if(q=q||10,X=X||0,X===0)this.internalStep(A),this.time+=A;else{var g=Math.floor((this.time+X)/A)-Math.floor(this.time/A);g=Math.min(g,q);for(var z=performance.now(),w=0;w!==g&&(this.internalStep(A),!(performance.now()-z>A*1e3));w++);this.time+=X;for(var m=this.time%A,y=m/A,C=rt,G=this.bodies,W=0;W!==G.length;W++){var E=G[W];E.type!==a.STATIC&&E.sleepState!==a.SLEEPING?(E.position.vsub(E.previousPosition,C),C.scale(y,C),E.position.vadd(C,E.interpolatedPosition)):(E.interpolatedPosition.copy(E.position),E.interpolatedQuaternion.copy(E.quaternion))}}};var P={type:"postStep"},k={type:"preStep"},M={type:"collide",body:null,contact:null},B=[],T=[],F=[],K=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new s;var Z=new s,ut=new s,R=new e;f.prototype.internalStep=function(A){this.dt=A;var X=this.contacts,q=F,g=K,z=this.numObjects(),w=this.bodies,m=this.solver,y=this.gravity,C=this.doProfiling,G=this.profile,W=a.DYNAMIC,E,L=this.constraints,_=T;y.norm();var pt=y.x,st=y.y,at=y.z,O=0;for(C&&(E=performance.now()),O=0;O!==z;O++){var Q=w[O];if(Q.type&W){var bt=Q.force,ft=Q.mass;bt.x+=ft*pt,bt.y+=ft*st,bt.z+=ft*at}}for(var O=0,Rt=this.subsystems.length;O!==Rt;O++)this.subsystems[O].update();C&&(E=performance.now()),q.length=0,g.length=0,this.broadphase.collisionPairs(this,q,g),C&&(G.broadphase=performance.now()-E);var Kt=L.length;for(O=0;O!==Kt;O++){var ht=L[O];if(!ht.collideConnected)for(var St=q.length-1;St>=0;St-=1)(ht.bodyA===q[St]&&ht.bodyB===g[St]||ht.bodyB===q[St]&&ht.bodyA===g[St])&&(q.splice(St,1),g.splice(St,1))}this.collisionMatrixTick(),C&&(E=performance.now());var zt=B,Mt=X.length;for(O=0;O!==Mt;O++)zt.push(X[O]);X.length=0;var Vt=this.frictionEquations.length;for(O=0;O!==Vt;O++)_.push(this.frictionEquations[O]);this.frictionEquations.length=0,this.narrowphase.getContacts(q,g,this,X,zt,this.frictionEquations,_),C&&(G.narrowphase=performance.now()-E),C&&(E=performance.now());for(var O=0;O<this.frictionEquations.length;O++)m.addEquation(this.frictionEquations[O]);for(var At=X.length,Ft=0;Ft!==At;Ft++){var ht=X[Ft],Q=ht.bi,Et=ht.bj;ht.si,ht.sj;var Wt;if(Q.material&&Et.material?Wt=this.getContactMaterial(Q.material,Et.material)||this.defaultContactMaterial:Wt=this.defaultContactMaterial,Wt.friction,Q.material&&Et.material&&(Q.material.friction>=0&&Et.material.friction>=0&&Q.material.friction*Et.material.friction,Q.material.restitution>=0&&Et.material.restitution>=0&&(ht.restitution=Q.material.restitution*Et.material.restitution)),m.addEquation(ht),Q.allowSleep&&Q.type===a.DYNAMIC&&Q.sleepState===a.SLEEPING&&Et.sleepState===a.AWAKE&&Et.type!==a.STATIC){var Ut=Et.velocity.norm2()+Et.angularVelocity.norm2(),ne=Math.pow(Et.sleepSpeedLimit,2);Ut>=ne*2&&(Q._wakeUpAfterNarrowphase=!0)}if(Et.allowSleep&&Et.type===a.DYNAMIC&&Et.sleepState===a.SLEEPING&&Q.sleepState===a.AWAKE&&Q.type!==a.STATIC){var ue=Q.velocity.norm2()+Q.angularVelocity.norm2(),ae=Math.pow(Q.sleepSpeedLimit,2);ue>=ae*2&&(Et._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,Et,!0),this.collisionMatrixPrevious.get(Q,Et)||(M.body=Et,M.contact=ht,Q.dispatchEvent(M),M.body=Q,Et.dispatchEvent(M))}for(C&&(G.makeContactConstraints=performance.now()-E,E=performance.now()),O=0;O!==z;O++){var Q=w[O];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var Kt=L.length;for(O=0;O!==Kt;O++){var ht=L[O];ht.update();for(var St=0,jt=ht.equations.length;St!==jt;St++){var ve=ht.equations[St];m.addEquation(ve)}}m.solve(A,this),C&&(G.solve=performance.now()-E),m.removeAllEquations();var pe=Math.pow;for(O=0;O!==z;O++){var Q=w[O];if(Q.type&W){var ie=pe(1-Q.linearDamping,A),ee=Q.velocity;ee.mult(ie,ee);var Yt=Q.angularVelocity;if(Yt){var re=pe(1-Q.angularDamping,A);Yt.mult(re,Yt)}}}for(this.dispatchEvent(k),O=0;O!==z;O++){var Q=w[O];Q.preStep&&Q.preStep.call(Q)}C&&(E=performance.now());var oe=Z,Gt=ut,de=this.stepnumber,fe=a.DYNAMIC|a.KINEMATIC,ye=de%(this.quatNormalizeSkip+1)===0,xe=this.quatNormalizeFast,ge=A*.5;for(p.types.PLANE,p.types.CONVEXPOLYHEDRON,O=0;O!==z;O++){var Lt=w[O],V=Lt.force,I=Lt.torque;if(Lt.type&fe&&Lt.sleepState!==a.SLEEPING){var H=Lt.velocity,D=Lt.angularVelocity,yt=Lt.position,nt=Lt.quaternion,J=Lt.invMass,ot=Lt.invInertiaWorld;H.x+=V.x*J*A,H.y+=V.y*J*A,H.z+=V.z*J*A,Lt.angularVelocity&&(ot.vmult(I,R),R.mult(A,R),R.vadd(D,D)),yt.x+=H.x*A,yt.y+=H.y*A,yt.z+=H.z*A,Lt.angularVelocity&&(oe.set(D.x,D.y,D.z,0),oe.mult(nt,Gt),nt.x+=ge*Gt.x,nt.y+=ge*Gt.y,nt.z+=ge*Gt.z,nt.w+=ge*Gt.w,ye&&(xe?nt.normalizeFast():nt.normalize())),Lt.aabb&&(Lt.aabbNeedsUpdate=!0),Lt.updateInertiaWorld&&Lt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,C&&(G.integrate=performance.now()-E),this.time+=A,this.stepnumber+=1,this.dispatchEvent(P),O=0;O!==z;O++){var Q=w[O],S=Q.postStep;S&&S.call(Q)}if(this.allowSleep)for(O=0;O!==z;O++)w[O].sleepTick(this.time)},f.prototype.clearForces=function(){for(var A=this.bodies,X=A.length,q=0;q!==X;q++){var g=A[q];g.force,g.torque,g.force.set(0,0,0),g.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Ce);var We=Ce.exports;const _t=Pe(We),Le={__name:"Demo14",setup(Ae){let Zt,v,N,ct,p=[];const e=async({THREE:o,scene:t,controls:i,transControls:n,camera:a,renderer:c})=>{c.shadowMap.enabled=!0,c.shadowMap.type=o.PCFSoftShadowMap;const h=new o.SphereGeometry(1),d=new o.TextureLoader().load("/home//public/images/lq.gif"),x=new o.MeshPhongMaterial({color:13199362,map:d});v=new o.Mesh(h,x),v.position.y=15,v.castShadow=!0,t.add(v);const f=new o.Group,b=new o.PlaneGeometry(100,50),U=new o.MeshLambertMaterial({color:8947848}),rt=new o.Mesh(b,U);rt.quaternion.setFromAxisAngle(new o.Vector3(1,0,0),-Math.PI/2),rt.castShadow=!0,rt.receiveShadow=!0,f.add(rt);let P=80,k=new o.BoxGeometry(1,1,1,10,10);for(let g=0;g<P;g++){const z=new o.Mesh(k,U);z.castShadow=!0,z.position.set(Math.random()*10-5,0,Math.random()*10-2),p.push(z),f.add(z)}t.add(f);let M=new o.PointLight(16777215,500,100);M.position.set(0,10,5),t.add(M),M.castShadow=!0,Zt=new _t.World,Zt.gravity.set(0,-9.82,0),Zt.quatNormalizeSkip=0,Zt.quatNormalizeFast=!1,Zt.broadphase=new _t.NaiveBroadphase;const B=new _t.Box(new _t.Vec3(.5,.5,.5));let T=new _t.Material;ct=new _t.Body({mass:5,shape:B,material:T}),ct.position.set(0,10,2),Zt.addBody(ct);const F=new _t.Sphere(1),K=new _t.Material;N=new _t.Body({mass:1,shape:F,material:K}),N.position.set(0,15,0),Zt.addBody(N);const Z=new _t.Plane,ut=new _t.Material,R=new _t.Body({mass:0,shape:Z,material:ut});R.quaternion.setFromAxisAngle(new _t.Vec3(1,0,0),-Math.PI/2),Zt.addBody(R);const A=new _t.ContactMaterial(ut,K,{restitution:.8});Zt.addContactMaterial(A);const X=()=>{v.position.y=15,N.position.set(0,15,0),p.forEach(g=>{g.position.set(Math.random()*10-5,0,Math.random()*10-5)})},q=function(g){switch(g.code){case"Space":X();break}};document.addEventListener("keydown",q)},s=({THREE:o,scene:t,controls:i,transControls:n,camera:a,renderer:c,stats:h})=>{Zt.step(.016666666666666666),v.position.copy(N.position),v.quaternion.copy(N.quaternion),i.update(),c.render(t,a),h.update()},{loading:r,pregress:l}=ze({el:"#canvas",background:"#111",cameraPosition:[0,10,20],control:!0,controlAutoSpeed:!0,helper:!1,light:!1,creatMesh:e,animation:s});return Fe(()=>{Zt=null}),(o,t)=>(Te(),Ne(Re,{loading:Ee(r),pregress:Ee(l)},{default:Ie(()=>t[0]||(t[0]=[be("canvas",{id:"canvas"},null,-1),be("div",{class:"text-box"},[be("p",null,"按”空格“重复播放碰撞动画")],-1)])),_:1},8,["loading","pregress"]))}},De=Ve(Le,[["__scopeId","data-v-128d5bd4"]]);export{De as default};
